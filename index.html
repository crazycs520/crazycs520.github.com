<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>crazycs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="crazycs">
<meta property="og:url" content="http://crazycs.com/index.html">
<meta property="og:site_name" content="crazycs">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="crazycs">
  
    <link rel="alternate" href="/atom.xml" title="crazycs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">crazycs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://crazycs.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/04/blog/" class="article-date">
  <time datetime="2017-03-04T15:59:29.000Z" itemprop="datePublished">2017-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/04/blog/">github+hexo搭建博客笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.　配置ssh秘钥</p>
<pre><code>sudo ssh-keygen -t rsa -C &quot;你的github邮箱&quot;
</code></pre><p>测试ssh公钥</p>
<pre><code>ssh -T git@github.com
</code></pre><p>设置ssh 公钥个人信息</p>
<pre><code>sudo git config --global user.name &quot;输入你的名字（）英文）”
sudo git config --global user.email “输入你的邮箱”
</code></pre><p>2.　安装git , nodejs , hexo<br>3.　初始化博客</p>
<pre><code>hexo inti blog
cd blog
npm install
</code></pre><p>检查，开启本地博客服务器，然后访问<a href="localhost:4001" target="_blank" rel="external">localhost:4001</a>。后面的-p 4001可以省略不写，写上是防止端口冲突。<br>    hexo s -p 4001</p>
<p>安装自动部署git 插件</p>
<pre><code>sudo npm install hexo-deployer-git --save
</code></pre><p>4.　配置_config.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">	type: git</div><div class="line">	repository:git@github.com:yourname/yourname.github.io.git(这个yourname改成你自己的名称)</div><div class="line">	branch: master</div></pre></td></tr></table></figure></p>
<p>5.　  hexo常用命令<br>hexo s　　开启本地服务器，一般先在本地查看，确认无误后在部署到github上<br>hexo clean    清楚缓存<br>hexo g　　        生成部署文件public<br>hexo d　        自动部署<br>hexo d -g    生成部署文件public 后　自动部署</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/04/blog/" data-id="cizvqbqiq0001w5cfr2p4y4qq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-express" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/04/express/" class="article-date">
  <time datetime="2017-03-04T13:44:24.000Z" itemprop="datePublished">2017-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/04/express/">express</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#express 学习记录<br><a href="http://ourjs.com/detail/56b2a6f088feaf2d031d2468" target="_blank" rel="external">原文地址http://ourjs.com/detail/56b2a6f088feaf2d031d2468</a></p>
<p>##入门</p>
<p>###安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g express-generator</div></pre></td></tr></table></figure></p>
<p>###新建一个工程<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">express <span class="_">-e</span> blog</div><div class="line"><span class="built_in">cd</span> blog</div><div class="line">npm install</div></pre></td></tr></table></figure></p>
<p>启动项目<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">`npm start`</div></pre></td></tr></table></figure></p>
<p>可以在浏览器里访问<a href="http://localhost:3000" target="_blank" rel="external">localhost:3000</a>    </p>
<p>###工程结构</p>
<ul>
<li><strong>app.js</strong>    :　启动(入口)文件<ul>
<li><strong>package.json</strong>:　工程项目信息和模块依赖，当在 dependencies 中添加依赖的模块时，运行npm install，npm 会检查当前目录下的 package.json，并自动安装所有指定的模块</li>
<li><strong>node_modules</strong>:存放安装的模块</li>
<li><strong>public</strong>:存放image,css,js 文件</li>
<li><strong>routes</strong>:存放路由文件</li>
<li><strong>views</strong>:存放视图模板文件<ul>
<li><strong>bin</strong>:存放可执行文件</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>##路由控制<br>routes/index.js　中有以下代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这段代码的作用的访问主页时，调用ejs模板引擎，来渲染index.ejs模板文件，生成静态页面并显示在浏览器中。　　</p>
<p>我们来作一些修改，以上代码实现了路由的功能，我们当然可以不要 routes/index.js 文件，把实现路由功能的代码都放在 app.js 里，但随着时间的推移 app.js 会变得臃肿难以维护，这也违背了代码模块化的思想，所以我们把实现路由功能的代码都放在 routes/index.js 里。官方给出的写法是在 app.js 中实现了简单的路由分配，然后再去 index.js 中找到对应的路由函数，最终实现路由功能。我们不妨把路由控制器和实现路由功能的函数都放到 index.js 里，app.js 中只有一个总的路由接口。<br>最终将 app.js 修改为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line"></div><div class="line"><span class="comment">// uncomment after placing your favicon in /public</span></div><div class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));</span></div><div class="line">app.use(logger(<span class="string">'dev'</span>));</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</div><div class="line">app.use(cookieParser());</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line">routes(app);</div><div class="line"></div><div class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Express server listening on port '</span> + app.get(<span class="string">'port'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>修改 index.js 如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</div><div class="line">  app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>最后修改package.json文件中的”start”字段如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"start": "node ./app.js"</div></pre></td></tr></table></figure></p>
<p>重新运行<code>npm start</code>，和之前一样。</p>
<p>###路由规则<br>express 封装了很多http请求方式，常用的只有<code>get</code> 和 <code>post</code>,即<code>app.get()</code>和<code>app.post()</code>。<code>app.get()</code>和<code>app.post()</code>的第一个参数都是请求路径，第二个参数是处理请求的回调函数，回调函数有两个参数分别是req和res，代表请求和响应信息。路径请求及对应的获取路径有以下几种形式：<br><strong>req.query</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET /search?q=tobi+ferret  </span></div><div class="line">req.query.q  </div><div class="line"><span class="comment">// =&gt; "tobi ferret"  </span></div><div class="line"></div><div class="line"><span class="comment">// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse  </span></div><div class="line">req.query.order  </div><div class="line"><span class="comment">// =&gt; "desc"  </span></div><div class="line"></div><div class="line">req.query.shoe.color  </div><div class="line"><span class="comment">// =&gt; "blue"  </span></div><div class="line"></div><div class="line">req.query.shoe.type  </div><div class="line"><span class="comment">// =&gt; "converse"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.body</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// POST user[name]=tobi&amp;user[email]=tobi@learnboost.com  </span></div><div class="line">req.body.user.name  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line">req.body.user.email  </div><div class="line"><span class="comment">// =&gt; "tobi@learnboost.com"  </span></div><div class="line"></div><div class="line"><span class="comment">// POST &#123; "name": "tobi" &#125;  </span></div><div class="line">req.body.name  </div><div class="line"><span class="comment">// =&gt; "tobi"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.params</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET /user/tj  </span></div><div class="line">req.params.name  </div><div class="line"><span class="comment">// =&gt; "tj"  </span></div><div class="line"></div><div class="line"><span class="comment">// GET /file/javascripts/jquery.js  </span></div><div class="line">req.params[<span class="number">0</span>]  </div><div class="line"><span class="comment">// =&gt; "javascripts/jquery.js"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.param</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ?name=tobi  </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line"><span class="comment">// POST name=tobi  </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line"><span class="comment">// /user/tobi for /user/:name   </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"</span></div></pre></td></tr></table></figure></p>
<p>不难看出：</p>
<ul>
<li><p><code>req.query</code>:处理get 请求，获取get请求参数</p>
</li>
<li><p><code>req.params</code>:处理 /:xxx 形式的 get 或 post 请求，获取请求参数</p>
</li>
<li><p><code>req.body</code>:处理 post 请求，获取 post 请求体</p>
</li>
<li><p><code>req.param()</code>:处理 get 和 post 请求，但查找优先级由高到低为 req.params→req.body→req.query</p>
<p>路径规则还支持正则表达式，更多请查阅 <a href="http://expressjs.com/en/api.html" target="_blank" rel="external">Express 官方文档</a> 。</p>
</li>
</ul>
<h3 id="添加路由规则"><a href="#添加路由规则" class="headerlink" title="添加路由规则"></a>添加路由规则</h3><p>当我们访问 localhost:3000 时，会显示：</p>
<p><img src="https://github.com/crazycs520/images/blob/master/1.png?raw=true" alt="ok"></p>
<p>当我们访问 localhost:3000/abcd 这种不存在的页面时就会显示：</p>
<p><img src="https://github.com/crazycs520/images/blob/master/2.png?raw=true" alt=""></p>
<p>因为不存在nswbmw 这个路径，所以express 返回了404　Not Found 的错误。下面添加这条路由规则，使得访问<a href="localhost:3000/abcd" target="_blank" rel="external">localhost:3000/abcd</a>，页面显示hello,world.</p>
<p>修改index.js，在<code>app.get(&#39;/&#39;)</code>后面添加一条路由规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/abcd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'hello world'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h2><h3 id="什么是模板引擎"><a href="#什么是模板引擎" class="headerlink" title="什么是模板引擎"></a>什么是模板引擎</h3><p>模板引擎（Template Engine）是一个将页面模板和要显示的数据结合起来生成 HTML 页面的工具。<br>如果说上面讲到的 express 中的路由控制方法相当于 MVC 中的控制器的话，那模板引擎就相当于 MVC 中的视图。</p>
<blockquote>
<p>模板引擎的功能是将页面模板和要显示的数据结合起来生成 HTML 页面。它既可以运 行在服务器端又可以运行在客户端，大多数时候它都在服务器端直接被解析为 HTML，解析完成后再传输给客户端，因此客户端甚至无法判断页面是否是模板引擎生成的。有时候模板引擎也可以运行在客户端，即浏览器中，典型的代表就是 XSLT，它以 XML 为输入，在客户端生成 HTML 页面。但是由于浏览器兼容性问题，XSLT 并不是很流行。目前的主流还是由服务器运行模板引擎。在 MVC 架构中，模板引擎包含在服务器端。控制器得到用户请求后，从模型获取数据，调用模板引擎。模板引擎以数据和页面模板为输入，生成 HTML 页面，然后返回给控制器，由控制器交回客户端。</p>
<p>——《Node.js开发指南》</p>
</blockquote>
<p><strong>什么是ejs？</strong></p>
<p>ejs 是模板引擎的一种，也是我们这个教程中使用的模板引擎，因为它使用起来十分简单，而且与 express 集成良好。</p>
<h3 id="使用模板引擎"><a href="#使用模板引擎" class="headerlink" title="使用模板引擎"></a>使用模板引擎</h3><p>前面我们通过以下两行代码设置了模板文件的存储位置和使用的模板引擎：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'views'</span>, __dirname + <span class="string">'/views'</span>);</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们通过 <code>express -e blog</code> 只是初始化了一个使用 ejs 模板引擎的工程而已，比如 node_modules 下添加了 ejs 模块，views 文件夹下有 index.ejs 。并不是说强制该工程只能使用 ejs 不能使用其他的模板引擎比如 jade，真正指定使用哪个模板引擎的是 <code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code> 。</p>
<p>在 routes/index.js 中通过调用 <code>res.render()</code> 渲染模版，并将其产生的页面直接返回给客户端。它接受两个参数，第一个是模板的名称，即 views 目录下的模板文件名，扩展名 .ejs 可选。第二个参数是传递给模板的数据对象，用于模板翻译。</p>
<p>打开 views/index.ejs ，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</div><div class="line">    &lt;link rel=&apos;stylesheet&apos; href=&apos;/stylesheets/style.css&apos; /&gt;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</div><div class="line">    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>当我们 <code>res.render(&#39;index&#39;, { title: &#39;Express&#39; });</code> 时，模板引擎会把 &lt;%= title %&gt; 替换成 Express，然后把替换后的页面显示给用户。</p>
<p>渲染后生成的页面代码为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to Express<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们通过 <code>app.use(express.static(path.join(__dirname, &#39;public&#39;)))</code> 设置了静态文件目录为 public 文件夹，所以上面代码中的 <code>href=&#39;/stylesheets/style.css&#39;</code> 就相当于<code>href=&#39;public/stylesheets/style.css&#39;</code> 。</p>
<p>ejs 的标签系统非常简单，它只有以下三种标签：</p>
<ul>
<li>&lt;% code %&gt;：JavaScript 代码。</li>
<li>&lt;%= code %&gt;：显示替换过 HTML 特殊字符的内容。</li>
<li>&lt;%- code %&gt;：显示原始 HTML 内容。</li>
</ul>
<p><strong>注意</strong>： <code>&lt;%= code %&gt;</code> 和 <code>&lt;%- code %&gt;</code> 的区别，当变量 code 为普通字符串时，两者没有区别。当 code 比如为 <code>&lt;h1&gt;hello&lt;/h1&gt;</code> 这种字符串时，<code>&lt;%= code %&gt;</code> 会原样输出 <code>&lt;h1&gt;hello&lt;/h1&gt;</code>，而 <code>&lt;%- code %&gt;</code> 则会显示 H1 大的 hello 字符串。</p>
<p>我们可以在 <code>&lt;% %&gt;</code> 内使用 JavaScript 代码。下面是 ejs 的官方示例：</p>
<p><strong>The Data</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supplies: [&apos;mop&apos;, &apos;broom&apos;, &apos;duster&apos;]</div></pre></td></tr></table></figure>
<p><strong>The Template</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">&lt;% for(var i=0; i&lt;supplies.length; i++) &#123;%&gt;</div><div class="line">   &lt;li&gt;&lt;%= supplies[i] %&gt;&lt;/li&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<p><strong>The Result</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">  &lt;li&gt;mop&lt;/li&gt;</div><div class="line">  &lt;li&gt;broom&lt;/li&gt;</div><div class="line">  &lt;li&gt;duster&lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<p>我们可以用上述三种标签实现页面模板系统能实现的任何内容。</p>
<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><p>这里我们不使用layout进行页面布局，而是使用更为简单灵活的include。include 的简单使用如下：</p>
<p><strong>index.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%- include a %&gt;</div><div class="line">hello,world!</div><div class="line">&lt;%- include b %&gt;</div></pre></td></tr></table></figure>
<p><strong>a.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div></pre></td></tr></table></figure>
<p><strong>b.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is b.ejs</div></pre></td></tr></table></figure>
<p>最终 index.ejs 会显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div><div class="line">hello,world!</div><div class="line">this is b.ejs</div></pre></td></tr></table></figure>
<p>这一节我们学习了模版引擎的相关知识，下一节我们正式开始学习如何从头开始搭建一个多人博客。</p>
<h2 id="搭建多人博客"><a href="#搭建多人博客" class="headerlink" title="搭建多人博客"></a>搭建多人博客</h2><h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><p>搭建一个简单的具有多人注册、登录、发表文章、登出功能的博客。</p>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><p>未登录：主页左侧导航显示 home、login、register，右侧显示已发表的文章、发表日期及作者。<br>登陆后：主页左侧导航显示 home、post、logout，右侧显示已发表的文章、发表日期及作者。<br>用户登录、注册、发表成功以及登出后都返回到主页。</p>
<p><strong>未登录</strong>：</p>
<p>主页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.6.jpg?raw=true" alt="img"></p>
<p>登录页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.7.jpg?raw=true" alt="img"></p>
<p>注册页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.8.jpg?raw=true" alt="img"></p>
<p><strong>登录后</strong>：</p>
<p>主页:</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.9.jpg?raw=true" alt="img"></p>
<p>发表页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.10.jpg?raw=true" alt="img"></p>
<p><strong>注意</strong>：没有登出页，当点击 LOGOUT 后，退出登陆并返回到主页。</p>
<h3 id="路由规划"><a href="#路由规划" class="headerlink" title="路由规划"></a>路由规划</h3><p>我们已经把设计的构想图贴出来了，接下来的任务就是完成路由规划了。路由规划，或者说控制器规划是整个网站的骨架部分，因为它处于整个架构的枢纽位置，相当于各个接口之间的粘合剂，所以应该优先考虑。</p>
<p>根据构思的设计图，我们作以下路由规划：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/ ：首页</div><div class="line">/login ：用户登录</div><div class="line">/reg ：用户注册</div><div class="line">/post ：发表文章</div><div class="line">/logout ：登出</div></pre></td></tr></table></figure>
<p>我们要求 <code>/login</code> 和 <code>/reg</code> 只能是未登录的用户访问，而 <code>/post</code> 和 <code>/logout</code> 只能是已登录的用户访问。左侧导航列表则针对已登录和未登录的用户显示不同的内容。</p>
<p>修改 index.js 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</div><div class="line">  app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'主页'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'reg'</span>, &#123; <span class="attr">title</span>: <span class="string">'注册'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'login'</span>, &#123; <span class="attr">title</span>: <span class="string">'登录'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'post'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如何针对已登录和未登录的用户显示不同的内容呢？或者说如何判断用户是否已经登陆了呢？进一步说如何记住用户的登录状态呢？我们通过引入会话（session）机制记录用户登录状态，还要访问数据库来保存和读取用户信息。下一节我们将学习如何使用数据库。</p>
<h2 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库"></a>使用数据库</h2><h3 id="MongoDB简介"><a href="#MongoDB简介" class="headerlink" title="MongoDB简介"></a>MongoDB简介</h3><p>MongoDB 是一个基于分布式文件存储的 NoSQL（非关系型数据库）的一种，由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 支持的数据结构非常松散，是类似 json 的 bjson 格式，因此可以存储比较复杂的数据类型。MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
<p>MongoDB 没有关系型数据库中行和表的概念，不过有类似的文档和集合的概念。文档是 MongoDB 最基本的单位，每个文档都会以唯一的 _id 标识，文档的属性为 key/value 的键值对形式，文档内可以嵌套另一个文档，因此可以存储比较复杂的数据类型。集合是许多文档的总和，一个数据库可以有多个集合，一个集合可以有多个文档。</p>
<p>下面是一个 MongoDB 文档的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">  &quot;_id&quot; : ObjectId( &quot;4f7fe8432b4a1077a7c551e8&quot; ),</div><div class="line">  &quot;name&quot; : &quot;nswbmw&quot;,</div><div class="line">  &quot;age&quot; : 22,</div><div class="line">  &quot;email&quot; : [ &quot;xxx@126.com&quot;, &quot;xxx@gmail.com&quot; ],</div><div class="line">  &quot;family&quot; : &#123;</div><div class="line">    &quot;mother&quot; : &#123; ... &#125;,</div><div class="line">    &quot;father&quot; : &#123; ... &#125;,</div><div class="line">    &quot;sister : &#123;</div><div class="line">      &quot;name&quot; : &quot;miaomiao&quot;,</div><div class="line">      &quot;age&quot; : 27,</div><div class="line">      &quot;email&quot; : &quot;xxx@163.com&quot;,</div><div class="line">      &quot;family&quot; : &#123;</div><div class="line">        &quot;mother&quot; : &#123; ... &#125;,</div><div class="line">        &quot;father&quot; : &#123; ... &#125;,</div><div class="line">        &quot;brother : &#123; ... &#125;,</div><div class="line">        &quot;husband&quot; : &#123; ... &#125;,</div><div class="line">        &quot;son&quot; : &#123; ... &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更多有关 MongoDB 的知识请参阅 《mongodb权威指南》或查阅：<a href="http://www.mongodb.org/" target="_blank" rel="external">http://www.mongodb.org/</a></p>
<h3 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h3><p>参考<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="external">官方安装指南</a></p>
<ul>
<li>Import the public key used by the package management system.¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6</div></pre></td></tr></table></figure>
<ul>
<li>Create a list file for MongoDB.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.listsudo touch /etc/apt/sources.list.d/mongodb-org-3.4.list</div></pre></td></tr></table></figure>
<ul>
<li>Reload local package database.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div></pre></td></tr></table></figure>
<ul>
<li>Install the MongoDB packages.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install -y mongodb-org</div></pre></td></tr></table></figure>
<ul>
<li>Start MongoDB</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod start</div></pre></td></tr></table></figure>
<ul>
<li><p>Verify that MongoDB has started successfully</p>
<p>Verify that the <a href="https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod" target="_blank" rel="external"><code>mongod</code></a> process has started successfully by checking the contents of the log file at<code>/var/log/mongodb/mongod.log</code> for a line reading</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[initandlisten] waiting for connections on port &lt;port&gt;</div></pre></td></tr></table></figure>
<p>where <code>&lt;port&gt;</code> is the port configured in <code>/etc/mongod.conf</code>, <code>27017</code> by default.</p>
<ul>
<li>Stop MongoDB</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod stop</div></pre></td></tr></table></figure>
<ul>
<li>Restart MongoDB.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod restart</div></pre></td></tr></table></figure>
<p><a href="http://mongodb.github.io/node-mongodb-native/2.2/quick-start/quick-start/" target="_blank" rel="external">Quick Start</a></p>
<p>以下是原作者的安装方法</p>
<p>安装 MongoDB 很简单,去<a href="http://www.mongodb.org/downloads" target="_blank" rel="external">官网</a>下载对应系统的 MongoDB 压缩包即可。解压后将文件夹重命名为 mongodb，并在 mongodb 文件夹里新建 blog 文件夹作为我们博客内容的存储目录。进入到 bin 目录下：运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./mongod --dbpath ../blog/</div></pre></td></tr></table></figure>
<p>以上命令的意思是:设置 blog 文件夹作为我们工程的存储目录并启动数据库。</p>
<h3 id="连接MongoDB"><a href="#连接MongoDB" class="headerlink" title="连接MongoDB"></a>连接MongoDB</h3><p>数据库虽然安装并启动成功了，但我们需要连接数据库后才能使用数据库。怎么才能在 Node.js 中使用 MongoDB 呢？我们使用官方提供的 node-mongodb-native 驱动模块，打开 package.json，在 dependencies 中添加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;mongodb&quot;: &quot;2.2.19&quot;</div></pre></td></tr></table></figure>
<p>然后运行 <code>npm install</code> 更新依赖的模块，稍等片刻后 mongodb 模块就下载并安装完成了。</p>
<p>接下来在工程的根目录中创建 settings.js 文件，用于保存该博客工程的配置信息，比如数据库的连接信息。我们将数据库命名为 blog，因为数据库服务器在本地，所以 settings.js 文件的内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123; </div><div class="line">  <span class="attr">cookieSecret</span>: <span class="string">'myblog'</span>, </div><div class="line">  <span class="attr">db</span>: <span class="string">'blog'</span>, </div><div class="line">  <span class="attr">host</span>: <span class="string">'localhost'</span>,</div><div class="line">  <span class="attr">port</span>: <span class="number">27017</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中 db 是数据库的名称，host 是数据库的地址，port是数据库的端口号，cookieSecret 用于 Cookie 加密与数据库无关，我们留作后用。</p>
<p>接下来在根目录下新建 models 文件夹，并在 models 文件夹下新建 db.js ，添加如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'../settings'</span>),</div><div class="line">       Db = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Db,</div><div class="line">       Connection = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Connection,</div><div class="line">       Server = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Server;</div><div class="line">   <span class="built_in">module</span>.exports = <span class="keyword">new</span> Db(settings.db, <span class="keyword">new</span> Server(settings.host, settings.port),</div><div class="line">&#123;<span class="attr">safe</span>: <span class="literal">true</span>&#125;);</div></pre></td></tr></table></figure>
<p>其中通过 <code>new Db(settings.db, new Server(settings.host, settings.port), {safe: true});</code> 设置数据库名、数据库地址和数据库端口创建了一个数据库连接实例，并通过 <code>module.exports</code> 导出该实例。这样，我们就可以通过 require 这个文件来对数据库进行读写了。</p>
<p>打开 app.js，在 <code>var routes = require(&#39;./routes/index&#39;);</code> 下添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'./settings'</span>);</div></pre></td></tr></table></figure>
<h3 id="会话支持"><a href="#会话支持" class="headerlink" title="会话支持"></a>会话支持</h3><blockquote>
<p>会话是一种持久的网络协议，用于完成服务器和客户端之间的一些交互行为。会话是一个比连接粒度更大的概念， 一次会话可能包含多次连接，每次连接都被认为是会话的一次操作。在网络应用开发中，有必要实现会话以帮助用户交互。例如网上购物的场景，用户浏览了多个页面，购买了一些物品，这些请求在多次连接中完成。许多应用层网络协议都是由会话支持的，如 FTP、Telnet 等，而 HTTP 协议是无状态的，本身不支持会话，因此在没有额外手段的帮助下，前面场景中服务器不知道用户购买了什么。</p>
<p>为了在无状态的 HTTP 协议之上实现会话，Cookie 诞生了。Cookie 是一些存储在客户端的信息，每次连接的时候由浏览器向服务器递交，服务器也向浏览器发起存储 Cookie 的请求，依靠这样的手段服务器可以识别客户端。我们通常意义上的 HTTP 会话功能就是这样实现的。具体来说，浏览器首次向服务器发起请求时，服务器生成一个唯一标识符并发送给客户端浏览器，浏览器将这个唯一标识符存储在 Cookie 中，以后每次再发起请求，客户端浏览器都会向服务器传送这个唯一标识符，服务器通过这个唯一标识符来识别用户。 对于开发者来说，我们无须关心浏览器端的存储，需要关注的仅仅是如何通过这个唯一标识符来识别用户。很多服务端脚本语言都有会话功能，如 PHP，把每个唯一标识符存储到文件中。</p>
<p>——《Node.js开发指南》</p>
</blockquote>
<p>express 也提供了会话中间件，默认情况下是把用户信息存储在内存中，但我们既然已经有了 MongoDB，不妨把会话信息存储在数据库中，便于持久维护。为了使用这一功能，我们需要借助 express-session 和 connect-mongo 这两个第三方中间件，在 package.json 中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;express-session&quot;: &quot;1.15.1&quot;,</div><div class="line">&quot;connect-mongo&quot;: &quot;2.2.19&quot;</div></pre></td></tr></table></figure>
<p>注意：如报”error setting ttl index on collection : sessions”错误，把”mongodb”&amp;”connect-mongo”版本号更到最新。</p>
<p>运行npm install安装模块,打开app.js，添加以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</div><div class="line"></div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: settings.cookieSecret,</div><div class="line">  <span class="attr">key</span>: settings.db,<span class="comment">//cookie name</span></div><div class="line">  cookie: &#123;<span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>&#125;,<span class="comment">//30 days</span></div><div class="line">  store: <span class="keyword">new</span> MongoStore(&#123;</div><div class="line">    <span class="attr">db</span>: settings.db,</div><div class="line">    <span class="attr">host</span>: settings.host,</div><div class="line">    <span class="attr">port</span>: settings.port</div><div class="line">  &#125;)</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>使用 express-session 和 connect-mongo 模块实现了将会化信息存储到mongoldb中。secret 用来防止篡改 cookie，key 的值为 cookie 的名字，通过设置 cookie 的 maxAge 值设定 cookie 的生存期，这里我们设置 cookie 的生存期为 30 天，设置它的 store 参数为 MongoStore 实例，把会话信息存储到数据库中，以避免丢失。在后面的小节中，我们可以通过 req.session 获取当前用户的会话对象，获取用户的相关信息。</p>
<h2 id="注册和登录"><a href="#注册和登录" class="headerlink" title="注册和登录"></a>注册和登录</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/04/express/" data-id="cizvqbqj30003w5cf0a7k3bdj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nodejs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/01/nodejs/" class="article-date">
  <time datetime="2017-03-01T04:59:15.000Z" itemprop="datePublished">2017-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/01/nodejs/">Node.JS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##Node.JS 简介</p>
<ul>
<li>共享状态的并发。注意回调函数和错误处理修改内存中的变量（状态）。</li>
<li>阻塞与非阻塞。nodejs采用事件轮询，故<strong>setTimeout()</strong>是非阻塞的，异步的。</li>
<li>Node并发采用事件轮询。</li>
<li>单线程。调用（执行）堆栈</li>
<li>错误处理。</li>
<li>堆栈追踪</li>
</ul>
<p>##Node 中的 API</p>
<ul>
<li>全局对象 <strong>global</strong></li>
<li>模块系统的三个核心对象:require,module,export</li>
<li>事件，监听。</li>
<li>buffer</li>
<li>stream</li>
<li>监视</li>
<li>事件驱动 <strong>events</strong><ul>
<li>events.EventEmitter</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/01/nodejs/" data-id="cizvqbqiz0002w5cfqqcrmbam" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js简介/">Node.js简介</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js简介/">Node.js简介</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Node-js简介/" style="font-size: 10px;">Node.js简介</a> <a href="/tags/express/" style="font-size: 10px;">express</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/04/blog/">github+hexo搭建博客笔记</a>
          </li>
        
          <li>
            <a href="/2017/03/04/express/">express</a>
          </li>
        
          <li>
            <a href="/2017/03/01/nodejs/">Node.JS</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 crazycs<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>