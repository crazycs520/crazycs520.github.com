<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>crazycs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="crazycs">
<meta property="og:url" content="http://crazycs.com/index.html">
<meta property="og:site_name" content="crazycs">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="crazycs">
  
    <link rel="alternate" href="/atom.xml" title="crazycs" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">crazycs</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://crazycs.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Session" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/06/Session/" class="article-date">
  <time datetime="2017-03-06T10:38:04.000Z" itemprop="datePublished">2017-03-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/06/Session/">Session</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是Session"><a href="#什么是Session" class="headerlink" title="什么是Session"></a>什么是Session</h1><p>session，中文经常翻译为会话，其本来的含义是指有始有终的一系列动作/消息，比如打电话时从拿起电话拨号到挂断电话这中间的一系列过程可以称之为一个session。有时候我们可以看到这样的话“在一个浏览器会话期间，…”，这里的会话一词用的就是其本义，是指从一个浏览器窗口打开到关闭这个期间①。最混乱的是“用户（客户端）在一次会话期间”这样一句话，它可能指用户的一系列动作（一般情况下是同某个具体目的相关的一系列动作，比如从登录到选购商品到结账登出这样一个网上购物的过程，有时候也被称为一个transaction），然而有时候也可能仅仅是指一次连接，也有可能是指含义①，其中的差别只能靠上下文来推断②。</p>
<p>然而当session一词与网络协议相关联时，它又往往隐含了“面向连接”和/或“保持状态”这样两个含义，“面向连接”指的是在通信双方在通信之前要先建立一个通信的渠道，比如打电话，直到对方接了电话通信才能开始，与此相对的是写信，在你把信发出去的时候你并不能确认对方的地址是否正确，通信渠道不一定能建立，但对发信人来说，通信已经开始了。“保持状态”则是指通信的一方能够把一系列的消息关联起来，使得消息之间可以互相依赖，比如一个服务员能够认出再次光临的老顾客并且记得上次这个顾客还欠店里一块钱。这一类的例子有“一个TCP session”或者“一个POP3 session”③。 </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/06/Session/" data-id="cizxzbgp50004rscft1lz7a16" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Promise" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/05/Promise/" class="article-date">
  <time datetime="2017-03-05T14:55:20.000Z" itemprop="datePublished">2017-03-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/05/Promise/">Promise</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="http://liubin.org/promises-book/" target="_blank" rel="external">原文地址</a></p>
<h2 id="什么是Promise"><a href="#什么是Promise" class="headerlink" title="什么是Promise"></a>什么是Promise</h2><h3 id="什么是Promise-1"><a href="#什么是Promise-1" class="headerlink" title="什么是Promise"></a>什么是Promise</h3><p>Promise是抽象异步处理对象以及对其进行各种操作的组件。</p>
<p>如果说到基于JavaScript的异步处理，我想大多数都会想到利用回调函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用了回调函数的异步处理</span></div><div class="line">getAsync(<span class="string">"fileA.txt"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error, result</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(error)&#123;<span class="comment">// 取得失败时的处理</span></div><div class="line">        <span class="keyword">throw</span> error;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 取得成功时的处理</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Node.js等则规定在JavaScript的回调函数的第一个参数为 <code>Error</code> 对象，这也是它的一个惯例。</p>
<p>像上面这样基于回调函数的异步处理如果统一参数使用规则的话，写法也会很明了。</p>
<p>而Promise则是把类似的异步处理对象和处理规则进行规范化， 并按照采用统一的接口来编写，而采取规定方法之外的写法都会出错。</p>
<p>下面是使用了Promise进行异步处理的一个例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">var promise = getAsyncPromise(&quot;fileA.txt&quot;); </div><div class="line">promise.then(function(result)&#123;</div><div class="line">    // 获取文件内容成功时的处理</div><div class="line">&#125;).catch(function(error)&#123;</div><div class="line">    // 获取文件内容失败时的处理</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这和回调函数方式相比有哪些不同之处呢？ 在使用promise进行一步处理的时候，我们必须按照接口规定的方法编写处理代码。</p>
<p>也就是说，除promise对象规定的方法(这里的 <code>then</code> 或 <code>catch</code>)以外的方法都是不可以使用的， 而不会像回调函数方式那样可以自己自由的定义回调函数的参数，而必须严格遵守固定、统一的编程方式来编写代码。</p>
<p>这样，基于Promise的统一接口的做法， 就可以形成基于接口的各种各样的异步处理模式。</p>
<p>所以，promise的功能是可以将复杂的异步处理轻松地进行模式化， 这也可以说得上是使用promise的理由之一。</p>
<h3 id="Promise-简介"><a href="#Promise-简介" class="headerlink" title="Promise 简介"></a>Promise 简介</h3><p>在 <a href="http://liubin.org/promises-book/#es6-promises" target="_blank" rel="external">ES6 Promises</a> 标准中定义的API还不是很多。</p>
<p>目前大致有下面三种类型。</p>
<ol>
<li><strong>Constructor</strong></li>
</ol>
<p>Promise类似于 <code>XMLHttpRequest</code>，从构造函数 <code>Promise</code> 来创建一个新建新<code>promise</code>对象作为接口。</p>
<p>要想创建一个promise对象、可以使用<code>new</code>来调用<code>Promise</code>的构造器来进行实例化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var promise = new Promise(function(resolve, reject) &#123;</div><div class="line">    // 异步处理</div><div class="line">    // 处理结束后、调用resolve 或 reject</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li><strong>Instance Method</strong></li>
</ol>
<p>对通过new生成的promise对象为了设置其值在 <strong>resolve</strong>(成功) / <strong>reject</strong>(失败)时调用的回调函数 可以使用<code>promise.then()</code> 实例方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">promise.then(onFulfilled, onRejected)</div></pre></td></tr></table></figure>
<ul>
<li><p>resolve(成功)时</p>
<p><code>onFulfilled</code> 会被调用</p>
</li>
<li><p>reject(失败)时</p>
<p><code>onRejected</code> 会被调用</p>
</li>
</ul>
<p><code>onFulfilled</code>、<code>onRejected</code> 两个都为可选参数。</p>
<p><code>promise.then</code> 成功和失败时都可以使用。 另外在只想对异常进行处理时可以采用 <code>promise.then(undefined, onRejected)</code> 这种方式，只指定reject时的回调函数即可。 不过这种情况下 <code>promise.catch(onRejected)</code> 应该是个更好的选择。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">promise.catch(onRejected)</div></pre></td></tr></table></figure>
<ol>
<li><strong>Static Method</strong></li>
</ol>
<p>像 <code>Promise</code> 这样的全局对象还拥有一些静态方法。</p>
<p>包括 <code>Promise.all()</code> 还有 <code>Promise.resolve()</code> ,<code>Promise.race()</code>等在内，主要都是一些对Promise进行操作的辅助方法。</p>
<h4 id="Promise-workflow"><a href="#Promise-workflow" class="headerlink" title="Promise workflow"></a>Promise workflow</h4><p>先来看一看下面的示例代码。</p>
<p>promise-workflow.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//1</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">        setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            resolve(<span class="string">'Async Hello world'</span>);</div><div class="line">        &#125;, <span class="number">16</span>);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">//2</span></div><div class="line">asyncFunction().then(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(value);    <span class="comment">// =&gt; 'Async Hello world'</span></div><div class="line">&#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li><code>new Promise</code>构造器之后，会返回一个promise对象</li>
<li>为promise对象用设置 <code>.then</code> 调用返回值时的回调函数。</li>
</ol>
<p><code>asyncFunction</code> 这个函数会返回promise对象， 对于这个promise对象，我们调用它的 <code>then</code> 方法来设置resolve后的回调函数， <code>catch</code> 方法来设置发生错误时的回调函数。</p>
<p>该promise对象会在setTimeout之后的16ms时被resolve, 这时 <code>then</code> 的回调函数会被调用，并输出 <code>&#39;Async Hello world&#39;</code> 。</p>
<p>当然，像<code>promise.then(onFulfilled, onRejected)</code> 的方法声明一样， 如果不使用<code>catch</code> 方法只使用 <code>then</code>方法的话，如下所示的代码也能完成相同的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">asyncFunction().then(function (value) &#123;</div><div class="line">    console.log(value);</div><div class="line">&#125;, function (error) &#123;</div><div class="line">    console.log(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Promise的状态"><a href="#Promise的状态" class="headerlink" title="Promise的状态"></a>Promise的状态</h4><p>用<code>new Promise</code> 实例化的promise对象有以下三个状态。</p>
<p>​    <strong>“has-resolution” - Fulfilled</strong></p>
<p>resolve(成功)时。此时会调用 <code>onFulfilled</code></p>
<p>​    <strong>“has-rejection” - Rejected</strong></p>
<p>reject(失败)时。此时会调用 <code>onRejected</code></p>
<p>​    <strong>“unresolved” - Pending</strong></p>
<p>既不是resolve也不是reject的状态。也就是promise对象刚被创建后的初始化状态等</p>
<p>promise对象的状态，从<em>Pending</em>转换为<em>Fulfilled</em>或<em>Rejected</em>之后， 这个promise对象的状态就不会再发生任何变化。</p>
<p>也就是说，Promise与Event等不同，在<code>.then</code> 后执行的函数可以肯定地说只会被调用一次。</p>
<p>另外，<em>Fulfilled</em>和<em>Rejected</em>这两个中的任一状态都可以表示为<strong>Settled</strong>(不变的)。</p>
<p>​    <strong>Settled</strong></p>
<p>resolve(成功) 或 reject(失败)。</p>
<p>当promise的对象状态发生变化时，用<code>.then</code> 来定义只会被调用一次的函数。</p>
<h3 id="编写Promise代码"><a href="#编写Promise代码" class="headerlink" title="编写Promise代码"></a>编写Promise代码</h3><h4 id="创建promise对象"><a href="#创建promise对象" class="headerlink" title="创建promise对象"></a>创建promise对象</h4><p>流程如下所示:</p>
<ol>
<li><code>new Promise(fn)</code> 返回一个promise对象</li>
<li>在<code>fn</code> 中指定异步等处理<ul>
<li>处理结果正常的话，调用<code>resolve(处理结果值)</code></li>
<li>处理结果错误的话，调用<code>reject(Error对象)</code></li>
</ul>
</li>
</ol>
<p><strong>创建XHR的promise对象</strong></p>
<p>首先，创建一个用Promise把XHR处理包装起来的名为 <code>getURL</code> 的函数。</p>
<p><em>xhr-promise.js</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">function getURL(URL) &#123;</div><div class="line">    return new Promise(function (resolve, reject) &#123;</div><div class="line">        var req = new XMLHttpRequest();</div><div class="line">        req.open(&apos;GET&apos;, URL, true);</div><div class="line">        req.onload = function () &#123;</div><div class="line">            if (req.status === 200) &#123;</div><div class="line">                resolve(req.responseText);</div><div class="line">            &#125; else &#123;</div><div class="line">                reject(new Error(req.statusText));</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        req.onerror = function () &#123;</div><div class="line">            reject(new Error(req.statusText));</div><div class="line">        &#125;;</div><div class="line">        req.send();</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line">// 运行示例</div><div class="line">var URL = &quot;http://httpbin.org/get&quot;;</div><div class="line">getURL(URL).then(function onFulfilled(value)&#123;</div><div class="line">    console.log(value);</div><div class="line">&#125;).catch(function onRejected(error)&#123;</div><div class="line">    console.error(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>getURL</code> 只有在通过XHR取得结果状态为200时才会调用 <code>resolve</code> - 也就是只有数据取得成功时，而其他情况（取得失败）时则会调用 <code>reject</code> 方法。</p>
<p><code>resolve(req.responseText)</code> 在response的内容中加入了参数。 resolve方法的参数并没有特别的规则，基本上把要传给回调函数参数放进去就可以了。 ( <code>then</code> 方法可以接收到这个参数值)</p>
<p>熟悉Node.js的人，经常会在写回调函数时将 <code>callback(error, response)</code> 的第一个参数设为error对象，而在Promise中resolve/reject则担当了这个职责（处理正常和异常的情况），所以 在resolve方法中只传一个response参数是没有问题的。</p>
<p>XHR中 <code>onerror</code> 事件被触发的时候就是发生错误时，所以理所当然调用<code>reject</code>。 这里我们重点来看一下传给<code>reject</code>的值。</p>
<p>发生错误时要像这样 <code>reject(new Error(req.statusText));</code> ，创建一个Error对象后再将具体的值传进去。 传给<code>reject</code> 的参数也没有什么特殊的限制，一般只要是Error对象（或者继承自Error对象）就可以。</p>
<p>传给<code>reject</code> 的参数，其中一般是包含了reject原因的Error对象。 本次因为状态值不等于200而被reject，所以<code>reject</code> 中放入的是statusText。 （这个参数的值可以被 <code>then</code> 方法的第二个参数或者 <code>catch</code> 方法中使用）</p>
<h4 id="编写promise对象处理方法"><a href="#编写promise对象处理方法" class="headerlink" title="编写promise对象处理方法"></a>编写promise对象处理方法</h4><p>我们在实际中使用一下刚才创建的返回promise对象的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getURL(&quot;http://example.com/&quot;); // =&gt; 返回promise对象</div></pre></td></tr></table></figure>
<p>如<em>Promises Overview</em>中做的简单介绍一样，promise对象拥有几个实例方法， 我们使用这些实例方法来为promise对象创建依赖于promise的具体状态、并且只会被执行一次的回调函数。</p>
<p>为promise对象添加处理方法主要有以下两种</p>
<ul>
<li>promise对象被 <strong>resolve</strong> 时的处理(onFulfilled)</li>
<li>promise对象被 <strong>reject</strong> 时的处理(onRejected)</li>
</ul>
<p>首先，我们来尝试一下为 <code>getURL</code> 通信成功并取到值时添加的处理函数。</p>
<p>此时所谓的 <em>通信成功</em> ， 指的就是在被resolve后， <em>promise对象变为FulFilled状态</em> 。</p>
<p>被<strong>resolve</strong>后的处理，可以在<a href="http://liubin.org/promises-book/#promise.then" target="_blank" rel="external"><code>.then</code></a> 方法中传入想要调用的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var URL = &quot;http://httpbin.org/get&quot;;</div><div class="line">getURL(URL).then(function onFulfilled(value)&#123; </div><div class="line">    console.log(value);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><a href="http://liubin.org/promises-book/#xhr-promise.js" target="_blank" rel="external">getURL函数</a> 中的 <code>resolve(req.responseText);</code> 会将promise对象变为resolve（Fulfilled）状态， 同时使用其值调用 <code>onFulfilled</code>函数。</p>
<p>不过目前我们还没有对其中可能发生的错误做任何处理， 接下来，我们就来为 <code>getURL</code> 函数添加发生错误时的异常处理。</p>
<p>此时 <em>发生错误</em> ， 指的也就是reject后 <em>promise对象变为Rejected状态</em> 。</p>
<p>被<strong>reject</strong>后的处理，可以在<a href="http://liubin.org/promises-book/#promise.then" target="_blank" rel="external"><code>.then</code> 的第二个参数</a> 或者是在 <a href="http://liubin.org/promises-book/#promise.catch" target="_blank" rel="external"><code>.catch</code></a> 方法中设置想要调用的函数。</p>
<p>把下面reject时的处理加入到刚才的代码，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var URL = &quot;http://httpbin.org/status/500&quot;; 		//1</div><div class="line">getURL(URL).then(function onFulfilled(value)&#123;</div><div class="line">    console.log(value);</div><div class="line">&#125;).catch(function onRejected(error)&#123; 			//2</div><div class="line">    console.error(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ol>
<li>服务端返回的状态码为500</li>
<li>为了方便理解函数被命名为 <code>onRejected</code></li>
</ol>
<p>在<code>getURL</code> 的处理中发生任何异常，或者被明确reject的情况下， 该异常原因（Error对象）会作为 <a href="http://liubin.org/promises-book/#promise.catch" target="_blank" rel="external"><code>.catch</code></a> 方法的参数被调用。</p>
<p>其实 <a href="http://liubin.org/promises-book/#promise.catch" target="_blank" rel="external"><code>.catch</code></a>只是 <code>promise.then(undefined, onRejected)</code> 的别名而已， 如下代码也可以完成同样的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getURL(URL).then(onFulfilled, onRejected);	//1</div></pre></td></tr></table></figure>
<ol>
<li>onFulfilled, onRejected 是和刚才相同的函数</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>用 <code>new Promise</code> 方法创建promise对象</li>
<li>用<a href="http://liubin.org/promises-book/#promise.then" target="_blank" rel="external"><code>.then</code></a> 或 <a href="http://liubin.org/promises-book/#promise.catch" target="_blank" rel="external"><code>.catch</code></a> 添加promise对象的处理函数</li>
</ul>
<p>实际上即使使用回调方式的写法也能完成上面同样的工作，而使用Promise方式的话有什么优点么？在本小节中我们没有讲到两者的对比及Promise的优点。在接下来的章节中，我们将会对Promise优点之一，即<strong>错误处理机制</strong>进行介绍，以及和传统的回调方式的对比。</p>
<h2 id="实战Promise"><a href="#实战Promise" class="headerlink" title="实战Promise"></a>实战Promise</h2><h3 id="Promise-resolve"><a href="#Promise-resolve" class="headerlink" title="Promise.resolve"></a>Promise.resolve</h3><h4 id="new-Promise的快捷方式"><a href="#new-Promise的快捷方式" class="headerlink" title="new Promise的快捷方式"></a>new Promise的快捷方式</h4><p>静态方法<a href="http://liubin.org/promises-book/#Promise.resolve" target="_blank" rel="external"><code>Promise.resolve(value)</code></a> 可以认为是 <code>new Promise()</code> 方法的快捷方式。</p>
<p>比如 <code>Promise.resolve(42);</code> 可以认为是以下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">new Promise(function(resolve)&#123;</div><div class="line">    resolve(42);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在这段代码中的 <code>resolve(42);</code> 会让这个promise对象立即进入确定（即resolved）状态，并将 <code>42</code> 传递给后面then里所指定的 <code>onFulfilled</code> 函数。</p>
<p>方法 <code>Promise.resolve(value);</code> 的返回值也是一个promise对象，所以我们可以像下面那样接着对其返回值进行 <code>.then</code> 调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Promise.resolve(42).then(function(value)&#123;</div><div class="line">    console.log(value);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><a href="http://liubin.org/promises-book/#Promise.resolve" target="_blank" rel="external">Promise.resolve</a>作为 <code>new Promise()</code> 的快捷方式，在进行promise对象的初始化或者编写测试代码的时候都非常方便。</p>
<h4 id="Thenable"><a href="#Thenable" class="headerlink" title="Thenable"></a>Thenable</h4><p><code>Promise.resolve</code> 方法另一个作用就是将 <a href="http://liubin.org/promises-book/#Thenable" target="_blank" rel="external">thenable</a> 对象转换为promise对象。</p>
<p><a href="http://liubin.org/promises-book/#es6-promises" target="_blank" rel="external">ES6 Promises</a>里提到了<a href="http://liubin.org/promises-book/#Thenable" target="_blank" rel="external">Thenable</a>这个概念，简单来说它就是一个非常类似promise的东西。</p>
<p>就像我们有时称具有 <code>.length</code> 方法的非数组对象为Array like一样，thenable指的是一个具有 <code>.then</code> 方法的对象。</p>
<p>这种将thenable对象转换为promise对象的机制要求thenable对象所拥有的 <code>then</code> 方法应该和Promise所拥有的 <code>then</code> 方法具有同样的功能和处理过程，在将thenable对象转换为promise对象的时候，还会巧妙的利用thenable对象原来具有的 <code>then</code> 方法。</p>
<p>到底什么样的对象能算是thenable的呢，最简单的例子就是 <a href="https://api.jquery.com/jQuery.ajax/" target="_blank" rel="external">jQuery.ajax()</a>，它的返回值就是thenable的。</p>
<p>因为<code>jQuery.ajax()</code> 的返回值是 <a href="http://api.jquery.com/jQuery.ajax/#jqXHR" target="_blank" rel="external">jqXHR Object</a> 对象，这个对象具有 <code>.then</code> 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$.ajax(<span class="string">'/json/comment.json'</span>);<span class="comment">// =&gt; 拥有 `.then` 方法的对象</span></div></pre></td></tr></table></figure>
<p>这个thenable的对象可以使用 <code>Promise.resolve</code> 来转换为一个promise对象。</p>
<p>变成了promise对象的话，就能直接使用 <code>then</code> 或者 <code>catch</code> 等这些在 <a href="http://liubin.org/promises-book/#es6-promises" target="_blank" rel="external">ES6 Promises</a>里定义的方法了。</p>
<p>将thenable对象转换promise对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">var promise = Promise.resolve($.ajax(&apos;/json/comment.json&apos;));// =&gt; promise对象</div><div class="line">promise.then(function(value)&#123;</div><div class="line">   console.log(value);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>注意</strong></p>
<p>jQuery和thenable</p>
<p><a href="https://api.jquery.com/jQuery.ajax/" target="_blank" rel="external">jQuery.ajax()</a>的返回值是一个具有 <code>.then</code> 方法的 <a href="http://api.jquery.com/jQuery.ajax/#jqXHR" target="_blank" rel="external">jqXHR Object</a>对象，这个对象继承了来自 <a href="http://api.jquery.com/category/deferred-object/" target="_blank" rel="external">Deferred Object</a> 的方法和属性。</p>
<p>但是Deferred Object并没有遵循<a href="http://liubin.org/promises-book/#promises-aplus" target="_blank" rel="external">Promises/A+</a>或<a href="http://liubin.org/promises-book/#es6-promises" target="_blank" rel="external">ES6 Promises</a>标准，所以即使看上去这个对象转换成了一个promise对象，但是会出现缺失部分信息的问题。</p>
<p>这个问题的根源在于jQuery的 <a href="http://api.jquery.com/category/deferred-object/" target="_blank" rel="external">Deferred Object</a> 的 <code>then</code> 方法机制与promise不同。</p>
<p>所以我们应该注意，即使一个对象具有 <code>.then</code> 方法，也不一定就能作为ES6 Promises对象使用。</p>
<p><code>Promise.resolve</code> 只使用了共通的方法 <code>then</code> ，提供了在不同的类库之间进行promise对象互相转换的功能。</p>
<p>这种转换为thenable的功能在之前是通过使用 <code>Promise.cast</code> 来完成的，从它的名字我们也不难想象它的功能是什么。</p>
<p>除了在编写使用Promise的类库等软件时需要对Thenable有所了解之外，通常作为end-user使用的时候，我们可能不会用到此功能。</p>
<p>简单总结一下 <code>Promise.resolve</code> 方法的话，可以认为它的作用就是将传递给它的参数填充（Fulfilled）到promise对象后并返回这个promise对象。</p>
<h3 id="Promise-reject"><a href="#Promise-reject" class="headerlink" title="Promise.reject"></a>Promise.reject</h3><p><a href="http://liubin.org/promises-book/#Promise.reject" target="_blank" rel="external"><code>Promise.reject(error)</code></a>是和 <a href="http://liubin.org/promises-book/#Promise.resolve" target="_blank" rel="external"><code>Promise.resolve(value)</code></a> 类似的静态方法，是 <code>new Promise()</code> 方法的快捷方式。</p>
<p>比如 <code>Promise.reject(new Error(&quot;出错了&quot;))</code> 就是下面代码的语法糖形式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">new Promise(function(resolve,reject)&#123;</div><div class="line">    reject(new Error(&quot;出错了&quot;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这段代码的功能是调用该promise对象通过then指定的 <code>onRejected</code> 函数，并将错误（Error）对象传递给这个 <code>onRejected</code> 函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Promise.reject(new Error(&quot;BOOM!&quot;)).catch(function(error)&#123;</div><div class="line">    console.error(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>它和<a href="http://liubin.org/promises-book/#Promise.resolve" target="_blank" rel="external"><code>Promise.resolve(value)</code></a> 的不同之处在于promise内调用的函数是reject而不是resolve，这在编写测试代码或者进行debug时，说不定会用得上。</p>
<h3 id="专栏-Promise只能进行异步操作？"><a href="#专栏-Promise只能进行异步操作？" class="headerlink" title="专栏: Promise只能进行异步操作？"></a>专栏: Promise只能进行异步操作？</h3><p>在使用<a href="http://liubin.org/promises-book/#Promise.resolve" target="_blank" rel="external"><code>Promise.resolve(value)</code></a> 等方法的时候，如果promise对象立刻就能进入resolve状态的话，那么你是不是觉得 <code>.then</code> 里面指定的方法就是同步调用的呢？</p>
<p>实际上， <code>.then</code> 中指定的方法调用是异步进行的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">var promise = new Promise(function (resolve)&#123;</div><div class="line">    console.log(&quot;inner promise&quot;); // 1</div><div class="line">    resolve(42);</div><div class="line">&#125;);</div><div class="line">promise.then(function(value)&#123;</div><div class="line">    console.log(value); // 3</div><div class="line">&#125;);</div><div class="line">console.log(&quot;outer promise&quot;); // 2</div></pre></td></tr></table></figure>
<p>执行上面的代码会输出下面的log，从这些log我们清楚地知道了上面代码的执行顺序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">inner promise // 1</div><div class="line">outer promise // 2</div><div class="line">42            // 3</div></pre></td></tr></table></figure>
<p>由于JavaScript代码会按照文件的从上到下的顺序执行，所以最开始 <code>&lt;1&gt;</code> 会执行，然后是 <code>resolve(42);</code> 被执行。这时候 <code>promise</code> 对象的已经变为确定状态，FulFilled被设置为了 <code>42</code> 。</p>
<p>下面的代码 <code>promise.then</code> 注册了 <code>&lt;3&gt;</code> 这个回调函数，这是本专栏的焦点问题。</p>
<p>由于 <code>promise.then</code> 执行的时候promise对象已经是确定状态，从程序上说对回调函数进行同步调用也是行得通的。</p>
<p>但是即使在调用 <code>promise.then</code> 注册回调函数的时候promise对象已经是确定的状态，Promise也会以异步的方式调用该回调函数，这是在Promise设计上的规定方针。</p>
<p>因此 <code>&lt;2&gt;</code> 会最先被调用，最后才会调用回调函数 <code>&lt;3&gt;</code> 。</p>
<p>为什么要对明明可以以同步方式进行调用的函数，非要使用异步的调用方式呢？</p>
<h4 id="同步调用和异步调用同时存在导致的混乱"><a href="#同步调用和异步调用同时存在导致的混乱" class="headerlink" title="同步调用和异步调用同时存在导致的混乱"></a>同步调用和异步调用同时存在导致的混乱</h4><p>其实在Promise之外也存在这个问题，这里我们以一般的使用情况来考虑此问题。</p>
<p>这个问题的本质是接收回调函数的函数，会根据具体的执行情况，可以选择是以同步还是异步的方式对回调函数进行调用。</p>
<p>下面我们以 <code>onReady(fn)</code> 为例进行说明，这个函数会接收一个回调函数进行处理。</p>
<p>mixed-onready.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function onReady(fn) &#123;</div><div class="line">    var readyState = document.readyState;</div><div class="line">    if (readyState === &apos;interactive&apos; || readyState === &apos;complete&apos;) &#123;</div><div class="line">        fn();</div><div class="line">    &#125; else &#123;</div><div class="line">        window.addEventListener(&apos;DOMContentLoaded&apos;, fn);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">onReady(function () &#123;</div><div class="line">    console.log(&apos;DOM fully loaded and parsed&apos;);</div><div class="line">&#125;);</div><div class="line">console.log(&apos;==Starting==&apos;);</div></pre></td></tr></table></figure>
<p><a href="http://liubin.org/promises-book/#mixed-onready.js" target="_blank" rel="external">mixed-onready.js</a>会根据执行时DOM是否已经装载完毕来决定是对回调函数进行同步调用还是异步调用。</p>
<p>如果在调用onReady之前DOM已经载入的话</p>
<p>对回调函数进行同步调用</p>
<p>如果在调用onReady之前DOM还没有载入的话</p>
<p>通过注册 <code>DOMContentLoaded</code> 事件监听器来对回调函数进行异步调用</p>
<p>因此，如果这段代码在源文件中出现的位置不同，在控制台上打印的log消息顺序也会不同。</p>
<p>为了解决这个问题，我们可以选择统一使用异步调用的方式。</p>
<p>async-onready.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">function onReady(fn) &#123;</div><div class="line">    var readyState = document.readyState;</div><div class="line">    if (readyState === &apos;interactive&apos; || readyState === &apos;complete&apos;) &#123;</div><div class="line">        setTimeout(fn, 0);</div><div class="line">    &#125; else &#123;</div><div class="line">        window.addEventListener(&apos;DOMContentLoaded&apos;, fn);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">onReady(function () &#123;</div><div class="line">    console.log(&apos;DOM fully loaded and parsed&apos;);</div><div class="line">&#125;);</div><div class="line">console.log(&apos;==Starting==&apos;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">绝对不能对异步回调函数（即使在数据已经就绪）进行同步调用。</div><div class="line"></div><div class="line">如果对异步回调函数进行同步调用的话，处理顺序可能会与预期不符，可能带来意料之外的后果。</div><div class="line"></div><div class="line">对异步回调函数进行同步调用，还可能导致栈溢出或异常处理错乱等问题。</div><div class="line"></div><div class="line">如果想在将来某时刻调用异步回调函数的话，可以使用 setTimeout 等异步API。</div><div class="line">Effective JavaScript</div><div class="line">— David Herman</div></pre></td></tr></table></figure>
<p>前面我们看到的 <code>promise.then</code> 也属于此类，为了避免上述中同时使用同步、异步调用可能引起的混乱问题，Promise在规范上规定 <strong>Promise只能使用异步调用方式</strong> 。</p>
<p>最后，如果将上面的 <code>onReady</code> 函数用Promise重写的话，代码如下面所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">function onReadyPromise() &#123;</div><div class="line">    return new Promise(function (resolve, reject) &#123;</div><div class="line">        var readyState = document.readyState;</div><div class="line">        if (readyState === &apos;interactive&apos; || readyState === &apos;complete&apos;) &#123;</div><div class="line">            resolve();</div><div class="line">        &#125; else &#123;</div><div class="line">            window.addEventListener(&apos;DOMContentLoaded&apos;, resolve);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line">onReadyPromise().then(function () &#123;</div><div class="line">    console.log(&apos;DOM fully loaded and parsed&apos;);</div><div class="line">&#125;);</div><div class="line">console.log(&apos;==Starting==&apos;);</div></pre></td></tr></table></figure>
<p>由于Promise保证了每次调用都是以异步方式进行的，所以我们在实际编码中不需要调用 <code>setTimeout</code> 来自己实现异步调用。</p>
<h3 id="Promise-then"><a href="#Promise-then" class="headerlink" title="Promise#then"></a>Promise#then</h3><p>在前面的章节里我们对Promise基本的实例方法 <code>then</code> 和 <code>catch</code> 的使用方法进行了说明。</p>
<p>这其中，我想大家已经认识了 <code>.then().catch()</code> 这种链式方法的写法了，其实在Promise里可以将任意个方法连在一起作为一个方法链（method chain）。</p>
<p>promise可以写成方法链的形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">aPromise.then(function taskA(value)&#123;</div><div class="line">// task A</div><div class="line">&#125;).then(function taskB(vaue)&#123;</div><div class="line">// task B</div><div class="line">&#125;).catch(function onRejected(error)&#123;</div><div class="line">    console.log(error);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果把在 <code>then</code> 中注册的每个回调函数称为task的话，那么我们就可以通过Promise方法链方式来编写能以taskA → task B 这种流程进行处理的逻辑了。</p>
<p>Promise方法链这种叫法有点长（其实是在日语里有点长，中文还可以 –译者注），因此后面我们会简化为 <a href="http://liubin.org/promises-book/#promise-chain" target="_blank" rel="external">promise chain</a> 这种叫法。</p>
<p>Promise之所以适合编写异步处理较多的应用，promise chain可以算得上是其中的一个原因吧。</p>
<p>在本小节，我们将主要针对使用 <code>then</code> 的promise chain的行为和流程进行学习。</p>
<h4 id="Promise-chain"><a href="#Promise-chain" class="headerlink" title="Promise chain"></a>Promise chain</h4><p>在第一章 <a href="http://liubin.org/promises-book/#promise-chain" target="_blank" rel="external">promise chain</a> 里我们看到了一个很简单的 then → catch 的例子，如果我们将方法链的长度变得更长的话，那在每个promise对象中注册的onFulfilled和onRejected将会怎样执行呢？</p>
<p>注：promise chain - 即方法链越短越好。 在这个例子里我们是为了方便说明才选择了较长的方法链。</p>
<p>我们先来看看下面这样的promise chain。</p>
<p>promise-then-catch-flow.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">function taskA() &#123;</div><div class="line">    console.log(&quot;Task A&quot;);</div><div class="line">&#125;</div><div class="line">function taskB() &#123;</div><div class="line">    console.log(&quot;Task B&quot;);</div><div class="line">&#125;</div><div class="line">function onRejected(error) &#123;</div><div class="line">    console.log(&quot;Catch Error: A or B&quot;, error);</div><div class="line">&#125;</div><div class="line">function finalTask() &#123;</div><div class="line">    console.log(&quot;Final Task&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">var promise = Promise.resolve();</div><div class="line">promise</div><div class="line">    .then(taskA)</div><div class="line">    .then(taskB)</div><div class="line">    .catch(onRejected)</div><div class="line">    .then(finalTask);</div></pre></td></tr></table></figure>
<p>上面代码中的promise chain的执行流程</p>
<p><img src="http://github.com/crazycs520/images/blob/master/3.png?raw=true" alt=""></p>
<p>在 <a href="http://liubin.org/promises-book/#promise-then-catch-flow.js" target="_blank" rel="external">上述代码</a> 中，我们没有为 <code>then</code> 方法指定第二个参数(onRejected)，也可以像下面这样来理解。</p>
<ul>
<li><p><code>then</code></p>
<p>注册onFulfilled时的回调函数</p>
</li>
<li><p><code>catch</code></p>
<p>注册onRejected时的回调函数</p>
</li>
</ul>
<p>再看一下 <a href="http://liubin.org/promises-book/#promise-then-catch-flow.png" target="_blank" rel="external">上面的流程图</a> 的话，我们会发现 <em>Task A</em> 和 <em>Task B</em> 都有指向 <em>onRejected</em> 的线出来。</p>
<p>这些线的意思是在 <em>Task A</em> 或 <em>Task B</em> 的处理中，在下面的情况下就会调用 <em>onRejected</em> 方法。</p>
<ul>
<li>发生异常的时候</li>
<li>返回了一个Rejected状态的promise对象</li>
</ul>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ol>
<li>使用<code>promise.then(onFulfilled, onRejected)</code> 的话<ul>
<li>在 <code>onFulfilled</code> 中发生异常的话，在 <code>onRejected</code> 中是捕获不到这个异常的。</li>
</ul>
</li>
<li>在 <code>promise.then(onFulfilled).catch(onRejected)</code> 的情况下<ul>
<li><code>then</code> 中产生的异常能在 <code>.catch</code> 中捕获</li>
</ul>
</li>
<li><a href="http://liubin.org/promises-book/#promise.then" target="_blank" rel="external"><code>.then</code></a> 和 <a href="http://liubin.org/promises-book/#promise.catch" target="_blank" rel="external"><code>.catch</code></a> 在本质上是没有区别的<ul>
<li>需要分场合使用。</li>
</ul>
</li>
</ol>
<h2 id="Promise-测试"><a href="#Promise-测试" class="headerlink" title="Promise 测试"></a>Promise 测试</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/05/Promise/" data-id="cizxzbgou0002rscfnb7goq8s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-MongoDB" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/05/MongoDB/" class="article-date">
  <time datetime="2017-03-05T08:12:43.000Z" itemprop="datePublished">2017-03-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/05/MongoDB/">MongoDB</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="启动MongoDB服务"><a href="#启动MongoDB服务" class="headerlink" title="启动MongoDB服务"></a>启动MongoDB服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongod --dbpath /var/lib/mongodb/blog</div></pre></td></tr></table></figure>
<p>–dbpath 后接数据库目录</p>
<h2 id="MongoDB后台管理shell"><a href="#MongoDB后台管理shell" class="headerlink" title="MongoDB后台管理shell"></a>MongoDB后台管理shell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongo</div></pre></td></tr></table></figure>
<h2 id="MongoDB基本概念"><a href="#MongoDB基本概念" class="headerlink" title="MongoDB基本概念"></a>MongoDB基本概念</h2><table>
<thead>
<tr>
<th>SQL术语/概念</th>
<th>MongoDB术语/概念</th>
<th>解释/说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
<td>数据库表/集合</td>
</tr>
<tr>
<td>row</td>
<td>document</td>
<td>数据记录行/文档</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
<td>数据字段/域</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
<td>索引</td>
</tr>
<tr>
<td>table joins</td>
<td></td>
<td>表连接,MongoDB不支持</td>
</tr>
<tr>
<td>primary key</td>
<td>primary key</td>
<td>主键,MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody>
</table>
<p>执行 <strong>“db”</strong> 命令可以显示当前数据库对象或集合。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ mongo</div><div class="line">MongoDB shell version v3.4.2</div><div class="line">connecting to: mongodb://127.0.0.1:27017</div><div class="line">&gt; db</div><div class="line">test</div></pre></td></tr></table></figure>
<p>运行”use”命令，可以连接到一个指定的数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; use local</div><div class="line">switched to db local</div><div class="line">&gt; db</div><div class="line">local</div></pre></td></tr></table></figure>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><p>文档是一个键值(key-value)对(即BSON)。</p>
<p>文档的数据结构和JSON基本一样。</p>
<p>所有存储在集合中的数据都是BSON格式。</p>
<p>BSON是一种类json的一种二进制形式的存储格式,简称Binary JSON。</p>
<p>一个简单的文档例子如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;site&quot;:&quot;www.runoob.com&quot;, &quot;name&quot;:&quot;菜鸟教程&quot;&#125;</div></pre></td></tr></table></figure>
<p> RDBMS 与 MongoDB 对应的术语：</p>
<table>
<thead>
<tr>
<th>RDBMS</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库</td>
<td>数据库</td>
</tr>
<tr>
<td>表格</td>
<td>集合</td>
</tr>
<tr>
<td>行</td>
<td>文档</td>
</tr>
<tr>
<td>列</td>
<td>字段</td>
</tr>
<tr>
<td>表联合</td>
<td>嵌入文档</td>
</tr>
<tr>
<td>主键</td>
<td>主键 (MongoDB 提供了 key 为 _id )</td>
</tr>
</tbody>
</table>
<p>需要注意的是：</p>
<ol>
<li>文档中的键/值对是有序的。</li>
<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>MongoDB区分类型和大小写。</li>
<li>MongoDB的文档不能有重复的键。</li>
<li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li>
</ol>
<p>文档键命名规范：</p>
<ul>
<li>键不能含有\0 (空字符)。这个字符用来表示键的结尾。</li>
<li>.和$有特别的意义，只有在特定环境下才能使用。</li>
<li>以下划线”_”开头的键是保留的(不是严格要求的)。</li>
</ul>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>集合就是 MongoDB 文档组，类似于 RDBMS （关系数据库管理系统：Relational Database Management System)中的表格。</p>
<p>集合存在于数据库中，集合没有固定的结构，这意味着你在对集合可以插入不同格式和类型的数据，但通常情况下我们插入集合的数据都会有一定的关联性。</p>
<p>比如，我们可以将以下不同数据结构的文档插入到集合中：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"site"</span>:<span class="string">"www.baidu.com"</span>&#125;</div><div class="line">&#123;<span class="attr">"site"</span>:<span class="string">"www.google.com"</span>,<span class="attr">"name"</span>:<span class="string">"Google"</span>&#125;</div><div class="line">&#123;<span class="attr">"site"</span>:<span class="string">"www.runoob.com"</span>,<span class="attr">"name"</span>:<span class="string">"菜鸟教程"</span>,<span class="attr">"num"</span>:<span class="number">5</span>&#125;</div></pre></td></tr></table></figure>
<p>当第一个文档插入时，集合就会被创建。</p>
<h4 id="capped-collections"><a href="#capped-collections" class="headerlink" title="capped collections"></a>capped collections</h4><p>Capped collections 就是固定大小的collection。</p>
<p>它有很高的性能以及队列过期的特性(过期按照插入的顺序). 有点和 “RRD” 概念类似。</p>
<p>Capped collections是高性能自动的维护对象的插入顺序。它非常适合类似记录日志的功能 和标准的collection不同，你必须要显式的创建一个capped collection， 指定一个collection的大小，单位是字节。collection的数据存储空间值提前分配的。</p>
<p>要注意的是指定的存储大小包含了数据库的头信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.createCollection(&quot;mycoll&quot;, &#123;capped:true, size:100000&#125;)</div></pre></td></tr></table></figure>
<ul>
<li>在capped collection中，你能添加新的对象。</li>
<li>能进行更新，然而，对象不会增加存储空间。如果增加，更新就会失败 。</li>
<li>数据库不允许进行删除。使用drop()方法删除collection所有的行。</li>
<li>注意: 删除之后，你必须显式的重新创建这个collection。</li>
<li>在32bit机器中，capped collection最大存储为1e9( 1X10^9)个字节。</li>
</ul>
<h3 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h3><p>数据库的信息是存储在集合中。它们使用了系统的命名空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dbname.system.*</div></pre></td></tr></table></figure>
<p>在MongoDB数据库中名字空间 <dbname>.system.* 是包含多种系统信息的特殊集合(Collection)，如下:</dbname></p>
<table>
<thead>
<tr>
<th>集合命名空间</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>dbname.system.namespaces</td>
<td>列出所有名字空间。</td>
</tr>
<tr>
<td>dbname.system.indexes</td>
<td>列出所有索引。</td>
</tr>
<tr>
<td>dbname.system.profile</td>
<td>包含数据库概要(profile)信息。</td>
</tr>
<tr>
<td>dbname.system.users</td>
<td>列出所有可访问数据库的用户。</td>
</tr>
<tr>
<td>dbname.local.sources</td>
<td>包含复制对端（slave）的服务器信息和状态。</td>
</tr>
</tbody>
</table>
<h3 id="MongoDB数据类型"><a href="#MongoDB数据类型" class="headerlink" title="MongoDB数据类型"></a>MongoDB数据类型</h3><table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。</td>
</tr>
<tr>
<td>Integer</td>
<td>整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。</td>
</tr>
<tr>
<td>Boolean</td>
<td>布尔值。用于存储布尔值（真/假）</td>
</tr>
<tr>
<td>Double</td>
<td>双精度浮点值。用于存储浮点值。</td>
</tr>
<tr>
<td>Min/Max keys</td>
<td>将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。</td>
</tr>
<tr>
<td>Arrays</td>
<td>用于将数组或列表或多个值存储为一个键。</td>
</tr>
<tr>
<td>Timestamp</td>
<td>时间戳。记录文档修改或添加的具体时间。</td>
</tr>
<tr>
<td>Object</td>
<td>用于内嵌文档。</td>
</tr>
<tr>
<td>Null</td>
<td>用于创建空值。</td>
</tr>
<tr>
<td>Symbol</td>
<td>符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。</td>
</tr>
<tr>
<td>Date</td>
<td>日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。</td>
</tr>
<tr>
<td>Object ID</td>
<td>对象 ID。用于创建文档的 ID。</td>
</tr>
<tr>
<td>Binary Date</td>
<td>二进制数据。用于存储二进制数据。</td>
</tr>
<tr>
<td>Code</td>
<td>代码类型。用于在文档中存储 JavaScript 代码。</td>
</tr>
<tr>
<td>Regular expression</td>
<td>正则表达式类型。用于存储正则表达式。</td>
</tr>
</tbody>
</table>
<h2 id="MongoDB-连接"><a href="#MongoDB-连接" class="headerlink" title="MongoDB 连接"></a>MongoDB 连接</h2><p>使用 MongoDB shell 来连接 Mongodb 服务:</p>
<p>标准 URI 连接语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</div></pre></td></tr></table></figure>
<ul>
<li><strong>mongodb://</strong> 这是固定的格式，必须要指定。</li>
<li><strong>username:password@</strong> 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库</li>
<li><strong>host1</strong> 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</li>
<li><strong>portX</strong> 可选的指定端口，如果不填，默认为27017</li>
<li><strong>/database </strong>如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开admin数据库。</li>
<li><strong>?options</strong> 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</li>
</ul>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>replicaSet=name</td>
<td>验证replica set的名称。 Impliesconnect=replicaSet.</td>
</tr>
<tr>
<td>safe=true\</td>
<td>false</td>
<td>true: 在执行更新操作之后，驱动都会发送getLastError命令来确保更新成功。(还要参考 wtimeoutMS).　 false: 在每次更新之后，驱动不会发送getLastError来确保更新成功。</td>
</tr>
<tr>
<td>journal=true\</td>
<td>false</td>
<td>如果设置为 true, 同步到 journal (在提交到数据库前写入到实体中). 应用于 safe=true</td>
</tr>
<tr>
<td>connectTimeoutMS=ms</td>
<td>可以打开连接的时间。</td>
</tr>
<tr>
<td>socketTimeoutMS=ms</td>
<td>发送和接受sockets的时间。</td>
</tr>
</tbody>
</table>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>MongoDB 创建数据库的语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">use DATABASE_NAME</div></pre></td></tr></table></figure>
<p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">use test</div></pre></td></tr></table></figure>
<p>如果你想查看所有数据库，可以使用 <strong>show dbs</strong> 命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; show dbs</div><div class="line">local  0.078GB</div><div class="line">test   0.078GB</div></pre></td></tr></table></figure>
<p>可以看到，我们刚创建的数据库 test 并不在数据库的列表中， 要显示它，我们需要向 test 数据库插入一些数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; db.test.insert(&#123;&quot;name&quot;:&quot;菜鸟教程&quot;&#125;)</div><div class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</div><div class="line">&gt; show dbs</div><div class="line">local   0.078GB</div><div class="line">runoob  0.078GB</div><div class="line">test    0.078GB</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>MongoDB 中默认的数据库为 test，如果你没有创建新的数据库，集合将存放在 test 数据库中。</p>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><p>MongoDB 删除数据库的语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.dropDatabase()</div></pre></td></tr></table></figure>
<p>删除<strong>当前数据库</strong>，默认为 test，你可以使用 db 命令查看当前数据库名。</p>
<h2 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h2><p>MongoDB 使用 insert() 或 save() 方法向集合中插入文档，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db.COLLECTION_NAME.insert(document)</div></pre></td></tr></table></figure>
<p>以下文档可以存储在 MongoDB 的 runoob 数据库 的 col集合中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;db.col.insert(&#123;title: &apos;MongoDB 教程&apos;, </div><div class="line">    description: &apos;MongoDB 是一个 Nosql 数据库&apos;,</div><div class="line">    by: &apos;菜鸟教程&apos;,</div><div class="line">    url: &apos;http://www.runoob.com&apos;,</div><div class="line">    tags: [&apos;mongodb&apos;, &apos;database&apos;, &apos;NoSQL&apos;],</div><div class="line">    likes: 100</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>以上实例中 col 是集合名，如果该集合不在该数据库中， MongoDB 会自动创建该集合并插入文档。</p>
<p>查看已插入文档：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; db.col.find()</div><div class="line">&#123; &quot;_id&quot; : ObjectId(&quot;56064886ade2f21f36b03134&quot;), &quot;title&quot; : &quot;MongoDB 教程&quot;, &quot;description&quot; : &quot;MongoDB 是一个 Nosql 数据库&quot;, &quot;by&quot; : &quot;菜鸟教程&quot;, &quot;url&quot; : &quot;http://www.runoob.com&quot;, &quot;tags&quot; : [ &quot;mongodb&quot;, &quot;database&quot;, &quot;NoSQL&quot; ], &quot;likes&quot; : 100 &#125;</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>我们也可以将数据定义为一个变量，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt; document=(&#123;title: &apos;MongoDB 教程&apos;, </div><div class="line">    description: &apos;MongoDB 是一个 Nosql 数据库&apos;,</div><div class="line">    by: &apos;菜鸟教程&apos;,</div><div class="line">    url: &apos;http://www.runoob.com&apos;,</div><div class="line">    tags: [&apos;mongodb&apos;, &apos;database&apos;, &apos;NoSQL&apos;],</div><div class="line">    likes: 100</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>执行后显示结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">        &quot;title&quot; : &quot;MongoDB 教程&quot;,</div><div class="line">        &quot;description&quot; : &quot;MongoDB 是一个 Nosql 数据库&quot;,</div><div class="line">        &quot;by&quot; : &quot;菜鸟教程&quot;,</div><div class="line">        &quot;url&quot; : &quot;http://www.runoob.com&quot;,</div><div class="line">        &quot;tags&quot; : [</div><div class="line">                &quot;mongodb&quot;,</div><div class="line">                &quot;database&quot;,</div><div class="line">                &quot;NoSQL&quot;</div><div class="line">        ],</div><div class="line">        &quot;likes&quot; : 100</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行插入操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; db.col.insert(document)</div><div class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>插入文档你也可以使用 db.col.save(document) 命令。如果不指定 _id 字段 save() 方法类似于 insert() 方法。如果指定 _id 字段，则会更新该 _id 的数据。</p>
<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><h2 id="update-方法"><a href="#update-方法" class="headerlink" title="update() 方法"></a>update() 方法</h2><p>update() 方法用于更新已存在的文档。语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">db.collection.update(</div><div class="line">   &lt;query&gt;,</div><div class="line">   &lt;update&gt;,</div><div class="line">   &#123;</div><div class="line">     upsert: &lt;boolean&gt;,</div><div class="line">     multi: &lt;boolean&gt;,</div><div class="line">     writeConcern: &lt;document&gt;</div><div class="line">   &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<p><strong>参数说明：</strong></p>
<ul>
<li><strong>query </strong>: update的查询条件，类似sql update查询内where后面的。</li>
<li><strong>update </strong>: update的对象和一些更新的操作符（如$,$inc…）等，也可以理解为sql update查询内set后面的</li>
<li><strong>upsert </strong>: 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。</li>
<li><strong>multi </strong>: 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。</li>
<li><strong>writeConcern </strong>:可选，抛出异常的级别。</li>
</ul>
<p><strong>实例</strong></p>
<p>我们在集合 col 中插入如下数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt;db.col.insert(&#123;</div><div class="line">    title: &apos;MongoDB 教程&apos;, </div><div class="line">    description: &apos;MongoDB 是一个 Nosql 数据库&apos;,</div><div class="line">    by: &apos;菜鸟教程&apos;,</div><div class="line">    url: &apos;http://www.runoob.com&apos;,</div><div class="line">    tags: [&apos;mongodb&apos;, &apos;database&apos;, &apos;NoSQL&apos;],</div><div class="line">    likes: 100</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>接着我们通过 update() 方法来更新标题(title):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&gt;db.col.update(&#123;&apos;title&apos;:&apos;MongoDB 教程&apos;&#125;,&#123;$set:&#123;&apos;title&apos;:&apos;MongoDB&apos;&#125;&#125;)</div><div class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)   # 输出信息</div><div class="line">&gt; db.col.find().pretty()</div><div class="line">&#123;</div><div class="line">        &quot;_id&quot; : ObjectId(&quot;56064f89ade2f21f36b03136&quot;),</div><div class="line">        &quot;title&quot; : &quot;MongoDB&quot;,</div><div class="line">        &quot;description&quot; : &quot;MongoDB 是一个 Nosql 数据库&quot;,</div><div class="line">        &quot;by&quot; : &quot;菜鸟教程&quot;,</div><div class="line">        &quot;url&quot; : &quot;http://www.runoob.com&quot;,</div><div class="line">        &quot;tags&quot; : [</div><div class="line">                &quot;mongodb&quot;,</div><div class="line">                &quot;database&quot;,</div><div class="line">                &quot;NoSQL&quot;</div><div class="line">        ],</div><div class="line">        &quot;likes&quot; : 100</div><div class="line">&#125;</div><div class="line">&gt;</div></pre></td></tr></table></figure>
<p>可以看到标题(title)由原来的 “MongoDB 教程” 更新为了 “MongoDB”。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/05/MongoDB/" data-id="cizxzbgoa0000rscfjajmvvw7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/">MongoDB</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/04/blog/" class="article-date">
  <time datetime="2017-03-04T15:59:29.000Z" itemprop="datePublished">2017-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/04/blog/">github+hexo搭建博客笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>1.　配置ssh秘钥</p>
<pre><code>sudo ssh-keygen -t rsa -C &quot;你的github邮箱&quot;
</code></pre><p>测试ssh公钥</p>
<pre><code>ssh -T git@github.com
</code></pre><p>设置ssh 公钥个人信息</p>
<pre><code>sudo git config --global user.name &quot;输入你的名字（）英文）”
sudo git config --global user.email “输入你的邮箱”
</code></pre><p>2.　安装git , nodejs , hexo<br>3.　初始化博客</p>
<pre><code>hexo inti blog
cd blog
npm install
</code></pre><p>检查，开启本地博客服务器，然后访问<a href="localhost:4001" target="_blank" rel="external">localhost:4001</a>。后面的-p 4001可以省略不写，写上是防止端口冲突。<br>    hexo s -p 4001</p>
<p>安装自动部署git 插件</p>
<pre><code>sudo npm install hexo-deployer-git --save
</code></pre><p>4.　配置_config.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">	type: git</div><div class="line">	repository:git@github.com:yourname/yourname.github.io.git(这个yourname改成你自己的名称)</div><div class="line">	branch: master</div></pre></td></tr></table></figure></p>
<p>5.　  hexo常用命令<br>hexo s　　开启本地服务器，一般先在本地查看，确认无误后在部署到github上<br>hexo clean    清楚缓存<br>hexo g　　        生成部署文件public<br>hexo d　        自动部署<br>hexo d -g    生成部署文件public 后　自动部署</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/04/blog/" data-id="cizxzbgpm0005rscfqqn4q84m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-express" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/04/express/" class="article-date">
  <time datetime="2017-03-04T13:44:24.000Z" itemprop="datePublished">2017-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/04/express/">express</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#express 学习记录<br><a href="http://ourjs.com/detail/56b2a6f088feaf2d031d2468" target="_blank" rel="external">原文地址http://ourjs.com/detail/56b2a6f088feaf2d031d2468</a></p>
<p>##入门</p>
<p>###安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g express-generator</div></pre></td></tr></table></figure></p>
<p>###新建一个工程<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">express <span class="_">-e</span> blog</div><div class="line"><span class="built_in">cd</span> blog</div><div class="line">npm install</div></pre></td></tr></table></figure></p>
<p>启动项目<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">`npm start`</div></pre></td></tr></table></figure></p>
<p>可以在浏览器里访问<a href="http://localhost:3000" target="_blank" rel="external">localhost:3000</a>    </p>
<p>###工程结构</p>
<ul>
<li><strong>app.js</strong>    :　启动(入口)文件<ul>
<li><strong>package.json</strong>:　工程项目信息和模块依赖，当在 dependencies 中添加依赖的模块时，运行npm install，npm 会检查当前目录下的 package.json，并自动安装所有指定的模块</li>
<li><strong>node_modules</strong>:存放安装的模块</li>
<li><strong>public</strong>:存放image,css,js 文件</li>
<li><strong>routes</strong>:存放路由文件</li>
<li><strong>views</strong>:存放视图模板文件<ul>
<li><strong>bin</strong>:存放可执行文件</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>##路由控制<br>routes/index.js　中有以下代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</div><div class="line">  res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>这段代码的作用的访问主页时，调用ejs模板引擎，来渲染index.ejs模板文件，生成静态页面并显示在浏览器中。　　</p>
<p>我们来作一些修改，以上代码实现了路由的功能，我们当然可以不要 routes/index.js 文件，把实现路由功能的代码都放在 app.js 里，但随着时间的推移 app.js 会变得臃肿难以维护，这也违背了代码模块化的思想，所以我们把实现路由功能的代码都放在 routes/index.js 里。官方给出的写法是在 app.js 中实现了简单的路由分配，然后再去 index.js 中找到对应的路由函数，最终实现路由功能。我们不妨把路由控制器和实现路由功能的函数都放到 index.js 里，app.js 中只有一个总的路由接口。<br>最终将 app.js 修改为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> favicon = <span class="built_in">require</span>(<span class="string">'serve-favicon'</span>);</div><div class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</div><div class="line"><span class="keyword">var</span> routes = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.set(<span class="string">'port'</span>, process.env.PORT || <span class="number">3000</span>);</div><div class="line"></div><div class="line"><span class="comment">// view engine setup</span></div><div class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div><div class="line"></div><div class="line"><span class="comment">// uncomment after placing your favicon in /public</span></div><div class="line"><span class="comment">//app.use(favicon(path.join(__dirname, 'public', 'favicon.ico')));</span></div><div class="line">app.use(logger(<span class="string">'dev'</span>));</div><div class="line">app.use(bodyParser.json());</div><div class="line">app.use(bodyParser.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</div><div class="line">app.use(cookieParser());</div><div class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</div><div class="line"></div><div class="line">routes(app);</div><div class="line"></div><div class="line">app.listen(app.get(<span class="string">'port'</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Express server listening on port '</span> + app.get(<span class="string">'port'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>修改 index.js 如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</div><div class="line">  app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'Express'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>最后修改package.json文件中的”start”字段如下:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">"start": "node ./app.js"</div></pre></td></tr></table></figure></p>
<p>重新运行<code>npm start</code>，和之前一样。</p>
<p>###路由规则<br>express 封装了很多http请求方式，常用的只有<code>get</code> 和 <code>post</code>,即<code>app.get()</code>和<code>app.post()</code>。<code>app.get()</code>和<code>app.post()</code>的第一个参数都是请求路径，第二个参数是处理请求的回调函数，回调函数有两个参数分别是req和res，代表请求和响应信息。路径请求及对应的获取路径有以下几种形式：<br><strong>req.query</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET /search?q=tobi+ferret  </span></div><div class="line">req.query.q  </div><div class="line"><span class="comment">// =&gt; "tobi ferret"  </span></div><div class="line"></div><div class="line"><span class="comment">// GET /shoes?order=desc&amp;shoe[color]=blue&amp;shoe[type]=converse  </span></div><div class="line">req.query.order  </div><div class="line"><span class="comment">// =&gt; "desc"  </span></div><div class="line"></div><div class="line">req.query.shoe.color  </div><div class="line"><span class="comment">// =&gt; "blue"  </span></div><div class="line"></div><div class="line">req.query.shoe.type  </div><div class="line"><span class="comment">// =&gt; "converse"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.body</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// POST user[name]=tobi&amp;user[email]=tobi@learnboost.com  </span></div><div class="line">req.body.user.name  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line">req.body.user.email  </div><div class="line"><span class="comment">// =&gt; "tobi@learnboost.com"  </span></div><div class="line"></div><div class="line"><span class="comment">// POST &#123; "name": "tobi" &#125;  </span></div><div class="line">req.body.name  </div><div class="line"><span class="comment">// =&gt; "tobi"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.params</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET /user/tj  </span></div><div class="line">req.params.name  </div><div class="line"><span class="comment">// =&gt; "tj"  </span></div><div class="line"></div><div class="line"><span class="comment">// GET /file/javascripts/jquery.js  </span></div><div class="line">req.params[<span class="number">0</span>]  </div><div class="line"><span class="comment">// =&gt; "javascripts/jquery.js"</span></div></pre></td></tr></table></figure></p>
<p><strong>req.param</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ?name=tobi  </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line"><span class="comment">// POST name=tobi  </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"  </span></div><div class="line"></div><div class="line"><span class="comment">// /user/tobi for /user/:name   </span></div><div class="line">req.param(<span class="string">'name'</span>)  </div><div class="line"><span class="comment">// =&gt; "tobi"</span></div></pre></td></tr></table></figure></p>
<p>不难看出：</p>
<ul>
<li><p><code>req.query</code>:处理get 请求，获取get请求参数</p>
</li>
<li><p><code>req.params</code>:处理 /:xxx 形式的 get 或 post 请求，获取请求参数</p>
</li>
<li><p><code>req.body</code>:处理 post 请求，获取 post 请求体</p>
</li>
<li><p><code>req.param()</code>:处理 get 和 post 请求，但查找优先级由高到低为 req.params→req.body→req.query</p>
<p>路径规则还支持正则表达式，更多请查阅 <a href="http://expressjs.com/en/api.html" target="_blank" rel="external">Express 官方文档</a> 。</p>
</li>
</ul>
<h3 id="添加路由规则"><a href="#添加路由规则" class="headerlink" title="添加路由规则"></a>添加路由规则</h3><p>当我们访问 localhost:3000 时，会显示：</p>
<p><img src="https://github.com/crazycs520/images/blob/master/1.png?raw=true" alt="ok"></p>
<p>当我们访问 localhost:3000/abcd 这种不存在的页面时就会显示：</p>
<p><img src="https://github.com/crazycs520/images/blob/master/2.png?raw=true" alt=""></p>
<p>因为不存在nswbmw 这个路径，所以express 返回了404　Not Found 的错误。下面添加这条路由规则，使得访问<a href="localhost:3000/abcd" target="_blank" rel="external">localhost:3000/abcd</a>，页面显示hello,world.</p>
<p>修改index.js，在<code>app.get(&#39;/&#39;)</code>后面添加一条路由规则</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/abcd'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.send(<span class="string">'hello world'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h2><h3 id="什么是模板引擎"><a href="#什么是模板引擎" class="headerlink" title="什么是模板引擎"></a>什么是模板引擎</h3><p>模板引擎（Template Engine）是一个将页面模板和要显示的数据结合起来生成 HTML 页面的工具。<br>如果说上面讲到的 express 中的路由控制方法相当于 MVC 中的控制器的话，那模板引擎就相当于 MVC 中的视图。</p>
<blockquote>
<p>模板引擎的功能是将页面模板和要显示的数据结合起来生成 HTML 页面。它既可以运 行在服务器端又可以运行在客户端，大多数时候它都在服务器端直接被解析为 HTML，解析完成后再传输给客户端，因此客户端甚至无法判断页面是否是模板引擎生成的。有时候模板引擎也可以运行在客户端，即浏览器中，典型的代表就是 XSLT，它以 XML 为输入，在客户端生成 HTML 页面。但是由于浏览器兼容性问题，XSLT 并不是很流行。目前的主流还是由服务器运行模板引擎。在 MVC 架构中，模板引擎包含在服务器端。控制器得到用户请求后，从模型获取数据，调用模板引擎。模板引擎以数据和页面模板为输入，生成 HTML 页面，然后返回给控制器，由控制器交回客户端。</p>
<p>——《Node.js开发指南》</p>
</blockquote>
<p><strong>什么是ejs？</strong></p>
<p>ejs 是模板引擎的一种，也是我们这个教程中使用的模板引擎，因为它使用起来十分简单，而且与 express 集成良好。</p>
<h3 id="使用模板引擎"><a href="#使用模板引擎" class="headerlink" title="使用模板引擎"></a>使用模板引擎</h3><p>前面我们通过以下两行代码设置了模板文件的存储位置和使用的模板引擎：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">app.set(<span class="string">'views'</span>, __dirname + <span class="string">'/views'</span>);</div><div class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们通过 <code>express -e blog</code> 只是初始化了一个使用 ejs 模板引擎的工程而已，比如 node_modules 下添加了 ejs 模块，views 文件夹下有 index.ejs 。并不是说强制该工程只能使用 ejs 不能使用其他的模板引擎比如 jade，真正指定使用哪个模板引擎的是 <code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code> 。</p>
<p>在 routes/index.js 中通过调用 <code>res.render()</code> 渲染模版，并将其产生的页面直接返回给客户端。它接受两个参数，第一个是模板的名称，即 views 目录下的模板文件名，扩展名 .ejs 可选。第二个参数是传递给模板的数据对象，用于模板翻译。</p>
<p>打开 views/index.ejs ，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">  &lt;head&gt;</div><div class="line">    &lt;title&gt;&lt;%= title %&gt;&lt;/title&gt;</div><div class="line">    &lt;link rel=&apos;stylesheet&apos; href=&apos;/stylesheets/style.css&apos; /&gt;</div><div class="line">  &lt;/head&gt;</div><div class="line">  &lt;body&gt;</div><div class="line">    &lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</div><div class="line">    &lt;p&gt;Welcome to &lt;%= title %&gt;&lt;/p&gt;</div><div class="line">  &lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>当我们 <code>res.render(&#39;index&#39;, { title: &#39;Express&#39; });</code> 时，模板引擎会把 &lt;%= title %&gt; 替换成 Express，然后把替换后的页面显示给用户。</p>
<p>渲染后生成的页面代码为：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">'stylesheet'</span> <span class="attr">href</span>=<span class="string">'/stylesheets/style.css'</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Express<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Welcome to Express<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们通过 <code>app.use(express.static(path.join(__dirname, &#39;public&#39;)))</code> 设置了静态文件目录为 public 文件夹，所以上面代码中的 <code>href=&#39;/stylesheets/style.css&#39;</code> 就相当于<code>href=&#39;public/stylesheets/style.css&#39;</code> 。</p>
<p>ejs 的标签系统非常简单，它只有以下三种标签：</p>
<ul>
<li>&lt;% code %&gt;：JavaScript 代码。</li>
<li>&lt;%= code %&gt;：显示替换过 HTML 特殊字符的内容。</li>
<li>&lt;%- code %&gt;：显示原始 HTML 内容。</li>
</ul>
<p><strong>注意</strong>： <code>&lt;%= code %&gt;</code> 和 <code>&lt;%- code %&gt;</code> 的区别，当变量 code 为普通字符串时，两者没有区别。当 code 比如为 <code>&lt;h1&gt;hello&lt;/h1&gt;</code> 这种字符串时，<code>&lt;%= code %&gt;</code> 会原样输出 <code>&lt;h1&gt;hello&lt;/h1&gt;</code>，而 <code>&lt;%- code %&gt;</code> 则会显示 H1 大的 hello 字符串。</p>
<p>我们可以在 <code>&lt;% %&gt;</code> 内使用 JavaScript 代码。下面是 ejs 的官方示例：</p>
<p><strong>The Data</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supplies: [&apos;mop&apos;, &apos;broom&apos;, &apos;duster&apos;]</div></pre></td></tr></table></figure>
<p><strong>The Template</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">&lt;% for(var i=0; i&lt;supplies.length; i++) &#123;%&gt;</div><div class="line">   &lt;li&gt;&lt;%= supplies[i] %&gt;&lt;/li&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<p><strong>The Result</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;ul&gt;</div><div class="line">  &lt;li&gt;mop&lt;/li&gt;</div><div class="line">  &lt;li&gt;broom&lt;/li&gt;</div><div class="line">  &lt;li&gt;duster&lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure>
<p>我们可以用上述三种标签实现页面模板系统能实现的任何内容。</p>
<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><p>这里我们不使用layout进行页面布局，而是使用更为简单灵活的include。include 的简单使用如下：</p>
<p><strong>index.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%- include a %&gt;</div><div class="line">hello,world!</div><div class="line">&lt;%- include b %&gt;</div></pre></td></tr></table></figure>
<p><strong>a.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div></pre></td></tr></table></figure>
<p><strong>b.ejs</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this is b.ejs</div></pre></td></tr></table></figure>
<p>最终 index.ejs 会显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">this is a.ejs</div><div class="line">hello,world!</div><div class="line">this is b.ejs</div></pre></td></tr></table></figure>
<p>这一节我们学习了模版引擎的相关知识，下一节我们正式开始学习如何从头开始搭建一个多人博客。</p>
<h2 id="搭建多人博客"><a href="#搭建多人博客" class="headerlink" title="搭建多人博客"></a>搭建多人博客</h2><h3 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h3><p>搭建一个简单的具有多人注册、登录、发表文章、登出功能的博客。</p>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><p>未登录：主页左侧导航显示 home、login、register，右侧显示已发表的文章、发表日期及作者。<br>登陆后：主页左侧导航显示 home、post、logout，右侧显示已发表的文章、发表日期及作者。<br>用户登录、注册、发表成功以及登出后都返回到主页。</p>
<p><strong>未登录</strong>：</p>
<p>主页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.6.jpg?raw=true" alt="img"></p>
<p>登录页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.7.jpg?raw=true" alt="img"></p>
<p>注册页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.8.jpg?raw=true" alt="img"></p>
<p><strong>登录后</strong>：</p>
<p>主页:</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.9.jpg?raw=true" alt="img"></p>
<p>发表页：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.10.jpg?raw=true" alt="img"></p>
<p><strong>注意</strong>：没有登出页，当点击 LOGOUT 后，退出登陆并返回到主页。</p>
<h3 id="路由规划"><a href="#路由规划" class="headerlink" title="路由规划"></a>路由规划</h3><p>我们已经把设计的构想图贴出来了，接下来的任务就是完成路由规划了。路由规划，或者说控制器规划是整个网站的骨架部分，因为它处于整个架构的枢纽位置，相当于各个接口之间的粘合剂，所以应该优先考虑。</p>
<p>根据构思的设计图，我们作以下路由规划：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/ ：首页</div><div class="line">/login ：用户登录</div><div class="line">/reg ：用户注册</div><div class="line">/post ：发表文章</div><div class="line">/logout ：登出</div></pre></td></tr></table></figure>
<p>我们要求 <code>/login</code> 和 <code>/reg</code> 只能是未登录的用户访问，而 <code>/post</code> 和 <code>/logout</code> 只能是已登录的用户访问。左侧导航列表则针对已登录和未登录的用户显示不同的内容。</p>
<p>修改 index.js 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">app</span>) </span>&#123;</div><div class="line">  app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'index'</span>, &#123; <span class="attr">title</span>: <span class="string">'主页'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'reg'</span>, &#123; <span class="attr">title</span>: <span class="string">'注册'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'login'</span>, &#123; <span class="attr">title</span>: <span class="string">'登录'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    res.render(<span class="string">'post'</span>, &#123; <span class="attr">title</span>: <span class="string">'发表'</span> &#125;);</div><div class="line">  &#125;);</div><div class="line">  app.post(<span class="string">'/post'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">  app.get(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如何针对已登录和未登录的用户显示不同的内容呢？或者说如何判断用户是否已经登陆了呢？进一步说如何记住用户的登录状态呢？我们通过引入会话（session）机制记录用户登录状态，还要访问数据库来保存和读取用户信息。下一节我们将学习如何使用数据库。</p>
<h2 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库"></a>使用数据库</h2><h3 id="MongoDB简介"><a href="#MongoDB简介" class="headerlink" title="MongoDB简介"></a>MongoDB简介</h3><p>MongoDB 是一个基于分布式文件存储的 NoSQL（非关系型数据库）的一种，由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 支持的数据结构非常松散，是类似 json 的 bjson 格式，因此可以存储比较复杂的数据类型。MongoDB 最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
<p>MongoDB 没有关系型数据库中行和表的概念，不过有类似的文档和集合的概念。文档是 MongoDB 最基本的单位，每个文档都会以唯一的 _id 标识，文档的属性为 key/value 的键值对形式，文档内可以嵌套另一个文档，因此可以存储比较复杂的数据类型。集合是许多文档的总和，一个数据库可以有多个集合，一个集合可以有多个文档。</p>
<p>下面是一个 MongoDB 文档的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">  &quot;_id&quot; : ObjectId( &quot;4f7fe8432b4a1077a7c551e8&quot; ),</div><div class="line">  &quot;name&quot; : &quot;nswbmw&quot;,</div><div class="line">  &quot;age&quot; : 22,</div><div class="line">  &quot;email&quot; : [ &quot;xxx@126.com&quot;, &quot;xxx@gmail.com&quot; ],</div><div class="line">  &quot;family&quot; : &#123;</div><div class="line">    &quot;mother&quot; : &#123; ... &#125;,</div><div class="line">    &quot;father&quot; : &#123; ... &#125;,</div><div class="line">    &quot;sister : &#123;</div><div class="line">      &quot;name&quot; : &quot;miaomiao&quot;,</div><div class="line">      &quot;age&quot; : 27,</div><div class="line">      &quot;email&quot; : &quot;xxx@163.com&quot;,</div><div class="line">      &quot;family&quot; : &#123;</div><div class="line">        &quot;mother&quot; : &#123; ... &#125;,</div><div class="line">        &quot;father&quot; : &#123; ... &#125;,</div><div class="line">        &quot;brother : &#123; ... &#125;,</div><div class="line">        &quot;husband&quot; : &#123; ... &#125;,</div><div class="line">        &quot;son&quot; : &#123; ... &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>更多有关 MongoDB 的知识请参阅 《mongodb权威指南》或查阅：<a href="http://www.mongodb.org/" target="_blank" rel="external">http://www.mongodb.org/</a></p>
<h3 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h3><p>参考<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/" target="_blank" rel="external">官方安装指南</a></p>
<ul>
<li>Import the public key used by the package management system.¶</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6</div></pre></td></tr></table></figure>
<ul>
<li>Create a list file for MongoDB.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot; | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.listsudo touch /etc/apt/sources.list.d/mongodb-org-3.4.list</div></pre></td></tr></table></figure>
<ul>
<li>Reload local package database.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get update</div></pre></td></tr></table></figure>
<ul>
<li>Install the MongoDB packages.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install -y mongodb-org</div></pre></td></tr></table></figure>
<ul>
<li>Start MongoDB</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod start</div></pre></td></tr></table></figure>
<ul>
<li><p>Verify that MongoDB has started successfully</p>
<p>Verify that the <a href="https://docs.mongodb.com/manual/reference/program/mongod/#bin.mongod" target="_blank" rel="external"><code>mongod</code></a> process has started successfully by checking the contents of the log file at<code>/var/log/mongodb/mongod.log</code> for a line reading</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[initandlisten] waiting for connections on port &lt;port&gt;</div></pre></td></tr></table></figure>
<p>where <code>&lt;port&gt;</code> is the port configured in <code>/etc/mongod.conf</code>, <code>27017</code> by default.</p>
<ul>
<li>Stop MongoDB</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod stop</div></pre></td></tr></table></figure>
<ul>
<li>Restart MongoDB.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service mongod restart</div></pre></td></tr></table></figure>
<p><a href="http://mongodb.github.io/node-mongodb-native/2.2/quick-start/quick-start/" target="_blank" rel="external">Quick Start</a></p>
<p>以下是原作者的安装方法</p>
<p>安装 MongoDB 很简单,去<a href="http://www.mongodb.org/downloads" target="_blank" rel="external">官网</a>下载对应系统的 MongoDB 压缩包即可。解压后将文件夹重命名为 mongodb，并在 mongodb 文件夹里新建 blog 文件夹作为我们博客内容的存储目录。进入到 bin 目录下：运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./mongod --dbpath ../blog/</div></pre></td></tr></table></figure>
<p>以上命令的意思是:设置 blog 文件夹作为我们工程的存储目录并启动数据库。</p>
<h3 id="连接MongoDB"><a href="#连接MongoDB" class="headerlink" title="连接MongoDB"></a>连接MongoDB</h3><p>数据库虽然安装并启动成功了，但我们需要连接数据库后才能使用数据库。怎么才能在 Node.js 中使用 MongoDB 呢？我们使用官方提供的 node-mongodb-native 驱动模块，打开 package.json，在 dependencies 中添加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;mongodb&quot;: &quot;2.2.19&quot;</div></pre></td></tr></table></figure>
<p>然后运行 <code>npm install</code> 更新依赖的模块，稍等片刻后 mongodb 模块就下载并安装完成了。</p>
<p>接下来在工程的根目录中创建 settings.js 文件，用于保存该博客工程的配置信息，比如数据库的连接信息。我们将数据库命名为 blog，因为数据库服务器在本地，所以 settings.js 文件的内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = &#123; </div><div class="line">  <span class="attr">cookieSecret</span>: <span class="string">'myblog'</span>, </div><div class="line">  <span class="attr">db</span>: <span class="string">'blog'</span>, </div><div class="line">  <span class="attr">host</span>: <span class="string">'localhost'</span>,</div><div class="line">  <span class="attr">port</span>: <span class="number">27017</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中 db 是数据库的名称，host 是数据库的地址，port是数据库的端口号，cookieSecret 用于 Cookie 加密与数据库无关，我们留作后用。</p>
<p>接下来在根目录下新建 models 文件夹，并在 models 文件夹下新建 db.js ，添加如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'../settings'</span>),</div><div class="line">       Db = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Db,</div><div class="line">       Connection = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Connection,</div><div class="line">       Server = <span class="built_in">require</span>(<span class="string">'mongodb'</span>).Server;</div><div class="line">   <span class="built_in">module</span>.exports = <span class="keyword">new</span> Db(settings.db, <span class="keyword">new</span> Server(settings.host, settings.port),</div><div class="line">&#123;<span class="attr">safe</span>: <span class="literal">true</span>&#125;);</div></pre></td></tr></table></figure>
<p>其中通过 <code>new Db(settings.db, new Server(settings.host, settings.port), {safe: true});</code> 设置数据库名、数据库地址和数据库端口创建了一个数据库连接实例，并通过 <code>module.exports</code> 导出该实例。这样，我们就可以通过 require 这个文件来对数据库进行读写了。</p>
<p>打开 app.js，在 <code>var routes = require(&#39;./routes/index&#39;);</code> 下添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> settings = <span class="built_in">require</span>(<span class="string">'./settings'</span>);</div></pre></td></tr></table></figure>
<h3 id="会话支持"><a href="#会话支持" class="headerlink" title="会话支持"></a>会话支持</h3><blockquote>
<p>会话是一种持久的网络协议，用于完成服务器和客户端之间的一些交互行为。会话是一个比连接粒度更大的概念， 一次会话可能包含多次连接，每次连接都被认为是会话的一次操作。在网络应用开发中，有必要实现会话以帮助用户交互。例如网上购物的场景，用户浏览了多个页面，购买了一些物品，这些请求在多次连接中完成。许多应用层网络协议都是由会话支持的，如 FTP、Telnet 等，而 HTTP 协议是无状态的，本身不支持会话，因此在没有额外手段的帮助下，前面场景中服务器不知道用户购买了什么。</p>
<p>为了在无状态的 HTTP 协议之上实现会话，Cookie 诞生了。Cookie 是一些存储在客户端的信息，每次连接的时候由浏览器向服务器递交，服务器也向浏览器发起存储 Cookie 的请求，依靠这样的手段服务器可以识别客户端。我们通常意义上的 HTTP 会话功能就是这样实现的。具体来说，浏览器首次向服务器发起请求时，服务器生成一个唯一标识符并发送给客户端浏览器，浏览器将这个唯一标识符存储在 Cookie 中，以后每次再发起请求，客户端浏览器都会向服务器传送这个唯一标识符，服务器通过这个唯一标识符来识别用户。 对于开发者来说，我们无须关心浏览器端的存储，需要关注的仅仅是如何通过这个唯一标识符来识别用户。很多服务端脚本语言都有会话功能，如 PHP，把每个唯一标识符存储到文件中。</p>
<p>——《Node.js开发指南》</p>
</blockquote>
<p>express 也提供了会话中间件，默认情况下是把用户信息存储在内存中，但我们既然已经有了 MongoDB，不妨把会话信息存储在数据库中，便于持久维护。为了使用这一功能，我们需要借助 express-session 和 connect-mongo 这两个第三方中间件，在 package.json 中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;express-session&quot;: &quot;1.15.1&quot;,</div><div class="line">&quot;connect-mongo&quot;: &quot;0.8.2&quot;</div></pre></td></tr></table></figure>
<p>注意：如报”error setting ttl index on collection : sessions”错误，把”mongodb”&amp;”connect-mongo”版本号更到最新。</p>
<p>运行npm install安装模块,打开app.js，添加以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo'</span>)(session);</div><div class="line"></div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: settings.cookieSecret,</div><div class="line">  <span class="attr">key</span>: settings.db,<span class="comment">//cookie name</span></div><div class="line">  cookie: &#123;<span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>&#125;,<span class="comment">//30 days</span></div><div class="line">  store: <span class="keyword">new</span> MongoStore(&#123;</div><div class="line">    <span class="attr">db</span>: settings.db,</div><div class="line">    <span class="attr">host</span>: settings.host,</div><div class="line">    <span class="attr">port</span>: settings.port</div><div class="line">  &#125;)</div><div class="line">&#125;));</div></pre></td></tr></table></figure>
<p>使用 express-session 和 connect-mongo 模块实现了将会化信息存储到mongoldb中。secret 用来防止篡改 cookie，key 的值为 cookie 的名字，通过设置 cookie 的 maxAge 值设定 cookie 的生存期，这里我们设置 cookie 的生存期为 30 天，设置它的 store 参数为 MongoStore 实例，把会话信息存储到数据库中，以避免丢失。在后面的小节中，我们可以通过 req.session 获取当前用户的会话对象，获取用户的相关信息。</p>
<h2 id="注册和登录"><a href="#注册和登录" class="headerlink" title="注册和登录"></a>注册和登录</h2><h3 id="页面设计"><a href="#页面设计" class="headerlink" title="页面设计"></a>页面设计</h3><p>首先我们来完成主页、登录页和注册页的页面设计。</p>
<p>修改 views/index.ejs 如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span> <span class="attr">header</span> %&gt;</span></div><div class="line">这是主页</div><div class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span> <span class="attr">footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<p>在 views 文件夹下新建 header.ejs，添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;UTF-8&quot; /&gt;</div><div class="line">&lt;title&gt;Blog&lt;/title&gt;</div><div class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/stylesheets/style.css&quot;&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line"></div><div class="line">&lt;header&gt;</div><div class="line">&lt;h1&gt;&lt;%= title %&gt;&lt;/h1&gt;</div><div class="line">&lt;/header&gt;</div><div class="line"></div><div class="line">&lt;nav&gt;</div><div class="line">&lt;span&gt;&lt;a title=&quot;主页&quot; href=&quot;/&quot;&gt;home&lt;/a&gt;&lt;/span&gt;</div><div class="line">&lt;span&gt;&lt;a title=&quot;登录&quot; href=&quot;/login&quot;&gt;login&lt;/a&gt;&lt;/span&gt;</div><div class="line">&lt;span&gt;&lt;a title=&quot;注册&quot; href=&quot;/reg&quot;&gt;register&lt;/a&gt;&lt;/span&gt;</div><div class="line">&lt;/nav&gt;</div><div class="line"></div><div class="line">&lt;article&gt;</div></pre></td></tr></table></figure>
<p>新建 footer.ejs，添加如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>修改 public/stylesheets/style.css 如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* inspired by http://yihui.name/cn/ */</span></div><div class="line">*&#123;<span class="attribute">padding</span>:<span class="number">0</span>;<span class="attribute">margin</span>:<span class="number">0</span>;&#125;</div><div class="line"><span class="selector-tag">body</span>&#123;<span class="attribute">width</span>:<span class="number">600px</span>;<span class="attribute">margin</span>:<span class="number">2em</span> auto;<span class="attribute">padding</span>:<span class="number">0</span> <span class="number">2em</span>;<span class="attribute">font-size</span>:<span class="number">14px</span>;<span class="attribute">font-family</span>:<span class="string">"Microsoft YaHei"</span>;&#125;</div><div class="line"><span class="selector-tag">p</span>&#123;<span class="attribute">line-height</span>:<span class="number">24px</span>;<span class="attribute">margin</span>:<span class="number">1em</span> <span class="number">0</span>;&#125;</div><div class="line"><span class="selector-tag">header</span>&#123;<span class="attribute">padding</span>:.<span class="number">5em</span> <span class="number">0</span>;<span class="attribute">border-bottom</span>:<span class="number">1px</span> solid <span class="number">#cccccc</span>;&#125;</div><div class="line"><span class="selector-tag">nav</span>&#123;<span class="attribute">float</span>:left;<span class="attribute">font-family</span>:<span class="string">"Microsoft YaHei"</span>;<span class="attribute">font-size</span>:<span class="number">1.1em</span>;<span class="attribute">text-transform</span>:uppercase;<span class="attribute">margin-left</span>:-<span class="number">12em</span>;<span class="attribute">width</span>:<span class="number">9em</span>;<span class="attribute">text-align</span>:right;&#125;</div><div class="line"><span class="selector-tag">nav</span> <span class="selector-tag">a</span>&#123;<span class="attribute">display</span>:block;<span class="attribute">text-decoration</span>:none;<span class="attribute">padding</span>:.<span class="number">7em</span> <span class="number">1em</span>;<span class="attribute">color</span>:<span class="number">#000000</span>;&#125;</div><div class="line"><span class="selector-tag">nav</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>&#123;<span class="attribute">background-color</span>:<span class="number">#ff0000</span>;<span class="attribute">color</span>:<span class="number">#f9f9f9</span>;<span class="attribute">-webkit-transition</span>:color .<span class="number">2s</span> linear;&#125;</div><div class="line"><span class="selector-tag">article</span>&#123;<span class="attribute">font-size</span>:<span class="number">16px</span>;<span class="attribute">padding-top</span>:.<span class="number">5em</span>;&#125;</div><div class="line"><span class="selector-tag">article</span> <span class="selector-tag">a</span>&#123;<span class="attribute">color</span>:<span class="number">#dd0000</span>;<span class="attribute">text-decoration</span>:none;&#125;</div><div class="line"><span class="selector-tag">article</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span>&#123;<span class="attribute">color</span>:<span class="number">#333333</span>;<span class="attribute">text-decoration</span>:underline;&#125;</div><div class="line"><span class="selector-class">.info</span>&#123;<span class="attribute">font-size</span>:<span class="number">14px</span>;&#125;</div></pre></td></tr></table></figure>
<p>运行 app ，主页显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.6.jpg?raw=true" alt="img"></p>
<p>接下来在 views 文件夹下新建 login.ejs，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;%- include header %&gt;</div><div class="line">&lt;form method=&quot;post&quot;&gt;</div><div class="line">  用户名：&lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br /&gt;</div><div class="line">  密码：  &lt;input type=&quot;password&quot; name=&quot;password&quot;/&gt;&lt;br /&gt;</div><div class="line">         &lt;input type=&quot;submit&quot; value=&quot;登录&quot;/&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;%- include footer %&gt;</div></pre></td></tr></table></figure>
<p>登录页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.7.jpg?raw=true" alt="img"></p>
<p>在 views 文件夹下新建 reg.ejs，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;%- include header %&gt;</div><div class="line">&lt;form method=&quot;post&quot;&gt;</div><div class="line">  用户名：  &lt;input type=&quot;text&quot; name=&quot;name&quot;/&gt;&lt;br /&gt;</div><div class="line">  密码：    &lt;input type=&quot;password&quot; name=&quot;password&quot;/&gt;&lt;br /&gt;</div><div class="line">  确认密码：&lt;input type=&quot;password&quot; name=&quot;password-repeat&quot;/&gt;&lt;br /&gt;</div><div class="line">  邮箱：    &lt;input type=&quot;email&quot; name=&quot;email&quot;/&gt;&lt;br /&gt;</div><div class="line">           &lt;input type=&quot;submit&quot; value=&quot;注册&quot;/&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;%- include footer %&gt;</div></pre></td></tr></table></figure>
<p>注册页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.8.jpg?raw=true" alt="img"></p>
<p>至此，未登录时的主页、注册页、登录页都已经完成。</p>
<p>现在，启动我们的博客看看吧。</p>
<p><strong>注意</strong>：每次我们更新代码后，都需要手动停止并重启应用，使用 supervisor 模块可以解决这个问题，每当我们保存修改的文件时，supervisor 都会自动帮我们重启应用。通过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install -g supervisor</div></pre></td></tr></table></figure>
<p>安装 supervisor 。使用 supervisor 命令启动 app.js：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ supervisor app.js</div></pre></td></tr></table></figure>
<h3 id="页面通知"><a href="#页面通知" class="headerlink" title="页面通知"></a>页面通知</h3><p>接下来我们实现用户的注册和登陆，在这之前我们需要引入 flash 模块来实现页面通知（即成功与错误信息的显示）的功能。</p>
<p><strong>什么是 flash?</strong></p>
<p>我们所说的 flash 即 connect-flash 模块（<a href="https://github.com/jaredhanson/connect-flash" target="_blank" rel="external">https://github.com/jaredhanson/connect-flash</a>），flash 是一个在 session 中用于存储信息的特定区域。信息写入 flash ，下一次显示完毕后即被清除。典型的应用是结合重定向的功能，确保信息是提供给下一个被渲染的页面。</p>
<p>在 package.json 添加一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;connect-flash&quot;: &quot;0.1.1&quot;</div></pre></td></tr></table></figure>
<p>然后 <code>npm install</code> 安装 connect-flash 模块。修改 app.js ，在 <code>var settings = require(&#39;./settings&#39;);</code> 后添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">var flash = require(&apos;connect-flash&apos;);</div></pre></td></tr></table></figure>
<p>在 <code>app.set(&#39;view engine&#39;, &#39;ejs&#39;);</code> 后添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.use(flash());</div></pre></td></tr></table></figure>
<p>现在我们就可以使用 flash 功能了。</p>
<h3 id="注册响应"><a href="#注册响应" class="headerlink" title="注册响应"></a>注册响应</h3><p>前面我们已经完成了注册页，当然现在点击注册是没有效果的，因为我们还没有实现处理 POST 请求的功能，下面就来实现它。</p>
<p>在 models 文件夹下新建 user.js，添加如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongodb = <span class="built_in">require</span>(<span class="string">'./db'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">User</span>(<span class="params">user</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.name = user.name;</div><div class="line">  <span class="keyword">this</span>.password = user.password;</div><div class="line">  <span class="keyword">this</span>.email = user.email;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = User;</div><div class="line"></div><div class="line"><span class="comment">//存储用户信息</span></div><div class="line">User.prototype.save = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">  <span class="comment">//要存入数据库的用户文档</span></div><div class="line">  <span class="keyword">var</span> user = &#123;</div><div class="line">      <span class="attr">name</span>: <span class="keyword">this</span>.name,</div><div class="line">      <span class="attr">password</span>: <span class="keyword">this</span>.password,</div><div class="line">      <span class="attr">email</span>: <span class="keyword">this</span>.email</div><div class="line">  &#125;;</div><div class="line">  <span class="comment">//打开数据库</span></div><div class="line">  mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      <span class="keyword">return</span> callback(err);<span class="comment">//错误，返回 err 信息</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//读取 users 集合</span></div><div class="line">    db.collection(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">return</span> callback(err);<span class="comment">//错误，返回 err 信息</span></div><div class="line">      &#125;</div><div class="line">      <span class="comment">//将用户数据插入 users 集合</span></div><div class="line">      collection.insert(user, &#123;</div><div class="line">        <span class="attr">safe</span>: <span class="literal">true</span></div><div class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          <span class="keyword">return</span> callback(err);<span class="comment">//错误，返回 err 信息</span></div><div class="line">        &#125;</div><div class="line">        callback(<span class="literal">null</span>, user[<span class="number">0</span>]);<span class="comment">//成功！err 为 null，并返回存储后的用户文档</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//读取用户信息</span></div><div class="line">User.get = <span class="function"><span class="keyword">function</span>(<span class="params">name, callback</span>) </span>&#123;</div><div class="line">  <span class="comment">//打开数据库</span></div><div class="line">  mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      <span class="keyword">return</span> callback(err);<span class="comment">//错误，返回 err 信息</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//读取 users 集合</span></div><div class="line">    db.collection(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">return</span> callback(err);<span class="comment">//错误，返回 err 信息</span></div><div class="line">      &#125;</div><div class="line">      <span class="comment">//查找用户名（name键）值为 name 一个文档</span></div><div class="line">      collection.findOne(&#123;</div><div class="line">        <span class="attr">name</span>: name</div><div class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          <span class="keyword">return</span> callback(err);<span class="comment">//失败！返回 err 信息</span></div><div class="line">        &#125;</div><div class="line">        callback(<span class="literal">null</span>, user);<span class="comment">//成功！返回查询的用户信息</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>我们通过 <code>User.prototype.save</code> 实现了用户信息的存储，通过 <code>User.get</code> 实现了用户信息的读取。</p>
<p>打开 index.js ，在最前面添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var crypto = require(&apos;crypto&apos;),</div><div class="line">    User = require(&apos;../models/user.js&apos;);</div></pre></td></tr></table></figure>
<p>通过 <code>require()</code> 引入 crypto 模块和 user.js 用户模型文件，crypto 是 Node.js 的一个核心模块，我们用它生成散列值来加密密码。</p>
<p>修改 index.js 中 <code>app.post(&#39;/reg&#39;)</code> 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">app.post(<span class="string">'/reg'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> name = req.body.name,</div><div class="line">      password = req.body.password,</div><div class="line">      password_re = req.body[<span class="string">'password-repeat'</span>];</div><div class="line">  <span class="comment">//检验用户两次输入的密码是否一致</span></div><div class="line">  <span class="keyword">if</span> (password_re != password) &#123;</div><div class="line">    req.flash(<span class="string">'error'</span>, <span class="string">'两次输入的密码不一致!'</span>); </div><div class="line">    <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//返回注册页</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//生成密码的 md5 值</span></div><div class="line">  <span class="keyword">var</span> md5 = crypto.createHash(<span class="string">'md5'</span>),</div><div class="line">      password = md5.update(req.body.password).digest(<span class="string">'hex'</span>);</div><div class="line">  <span class="keyword">var</span> newUser = <span class="keyword">new</span> User(&#123;</div><div class="line">      <span class="attr">name</span>: name,</div><div class="line">      <span class="attr">password</span>: password,</div><div class="line">      <span class="attr">email</span>: req.body.email</div><div class="line">  &#125;);</div><div class="line">  <span class="comment">//检查用户名是否已经存在 </span></div><div class="line">  User.get(newUser.name, <span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      req.flash(<span class="string">'error'</span>, err);</div><div class="line">      <span class="keyword">return</span> res.redirect(<span class="string">'/'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (user) &#123;</div><div class="line">      req.flash(<span class="string">'error'</span>, <span class="string">'用户已存在!'</span>);</div><div class="line">      <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//返回注册页</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果不存在则新增用户</span></div><div class="line">    newUser.save(<span class="function"><span class="keyword">function</span> (<span class="params">err, user</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        req.flash(<span class="string">'error'</span>, err);</div><div class="line">        <span class="keyword">return</span> res.redirect(<span class="string">'/reg'</span>);<span class="comment">//注册失败返回主册页</span></div><div class="line">      &#125;</div><div class="line">      req.session.user = newUser;<span class="comment">//用户信息存入 session</span></div><div class="line">      req.flash(<span class="string">'success'</span>, <span class="string">'注册成功!'</span>);</div><div class="line">      res.redirect(<span class="string">'/'</span>);<span class="comment">//注册成功后返回主页</span></div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：我们把用户信息存储在了 session 里，以后就可以通过 req.session.user 读取用户信息。</p>
<ul>
<li><strong>req.body</strong>： 就是 POST 请求信息解析过后的对象，例如我们要访问 POST 来的表单内的 name=”password” 域的值，只需访问 req.body[‘password’] 或 req.body.password 即可。</li>
<li><strong>res.redirect</strong>： 重定向功能，实现了页面的跳转，更多关于 res.redirect 的信息请查阅：<a href="http://expressjs.com/api.html#res.redirect" target="_blank" rel="external">http://expressjs.com/api.html#res.redirect</a> 。</li>
<li><strong>User</strong>：在前面的代码中，我们直接使用了 User 对象。User 是一个描述数据的对象，即 MVC 架构中的模型。前面我们使用了许多视图和控制器，这是第一次接触到模型。与视图和控制器不同，模型是真正与数据打交道的工具，没有模型，网站就只是一个外壳，不能发挥真实的作用，因此它是框架中最根本的部分。</li>
</ul>
<p>现在，启动应用，在浏览器输入 localhost:3000 注册试试吧！注册成功后显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.11.jpg?raw=true" alt="img"></p>
<p>这样我们并不知道是否注册成功，我们查看数据库中是否存入了用户的信息，打开一个命令行切换到 mongodb/bin/ （保证数据库已打开的前提下），输入：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.12.jpg?raw=true" alt="img"></p>
<p>可以看到，用户信息已经成功存入数据库。</p>
<p>接下来我们实现当注册成功返回主页时，左侧导航显示 HOME 、POST 、LOGOUT ，右侧显示 <strong>注册成功！</strong> 字样，即添加 flash 的页面通知功能。</p>
<p>修改 header.ejs，将 <code>&lt;nav&gt;&lt;/nav&gt;</code> 修改如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">nav</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"主页"</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">user</span>) &#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"发表"</span> <span class="attr">href</span>=<span class="string">"/post"</span>&gt;</span>post<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"登出"</span> <span class="attr">href</span>=<span class="string">"/logout"</span>&gt;</span>logout<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; <span class="attr">else</span> &#123; %&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"登录"</span> <span class="attr">href</span>=<span class="string">"/login"</span>&gt;</span>login<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">title</span>=<span class="string">"注册"</span> <span class="attr">href</span>=<span class="string">"/reg"</span>&gt;</span>register<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></div></pre></td></tr></table></figure>
<p>在 <code>&lt;article&gt;</code> 后添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;% if (success) &#123; %&gt;</div><div class="line">  &lt;div&gt;&lt;%= success %&gt;&lt;/div&gt;</div><div class="line">&lt;% &#125; %&gt;</div><div class="line">&lt;% if (error) &#123; %&gt;</div><div class="line">  &lt;div&gt;&lt;%= error %&gt; &lt;/div&gt;</div><div class="line">&lt;% &#125; %&gt;</div></pre></td></tr></table></figure>
<p>修改 index.js ，将 <code>app.get(&#39;/&#39;)</code> 修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/&apos;, function (req, res) &#123;</div><div class="line">  res.render(&apos;index&apos;, &#123;</div><div class="line">    title: &apos;主页&apos;,</div><div class="line">    user: req.session.user,</div><div class="line">    success: req.flash(&apos;success&apos;).toString(),</div><div class="line">    error: req.flash(&apos;error&apos;).toString()</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>将 <code>app.get(&#39;reg&#39;)</code> 修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/reg&apos;, function (req, res) &#123;</div><div class="line">  res.render(&apos;reg&apos;, &#123;</div><div class="line">    title: &apos;注册&apos;,</div><div class="line">    user: req.session.user,</div><div class="line">    success: req.flash(&apos;success&apos;).toString(),</div><div class="line">    error: req.flash(&apos;error&apos;).toString()</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>现在运行我们的博客，注册成功后显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.13.jpg?raw=true" alt="img"></p>
<p>我们通过对 session 的使用实现了对用户状态的检测，再根据不同的用户状态显示不同的导航信息。<br>简单解释一下流程：用户在注册成功后，把用户信息存入 session ，页面跳转到主页显示 <strong>注册成功！</strong> 的字样。同时把 session 中的用户信息赋给变量 user ，在渲染 index.ejs 文件时通过检测 user 判断用户是否在线，根据用户状态的不同显示不同的导航信息。</p>
<p><code>success: req.flash(&#39;success&#39;).toString()</code> 的意思是将成功的信息赋值给变量 <code>success</code>， <code>error: req.flash(&#39;error&#39;).toString()</code> 的意思是将错误的信息赋值给变量 <code>error</code> ，然后我们在渲染 ejs 模版文件时传递这两个变量来进行检测并显示通知。</p>
<h3 id="登录与登出响应"><a href="#登录与登出响应" class="headerlink" title="登录与登出响应"></a>登录与登出响应</h3><p>现在我们来实现用户登录的功能。</p>
<p>打开 index.js ，将 <code>app.post(&#39;/login&#39;)</code> 修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/login&apos;, function (req, res) &#123;</div><div class="line">  //生成密码的 md5 值</div><div class="line">  var md5 = crypto.createHash(&apos;md5&apos;),</div><div class="line">      password = md5.update(req.body.password).digest(&apos;hex&apos;);</div><div class="line">  //检查用户是否存在</div><div class="line">  User.get(req.body.name, function (err, user) &#123;</div><div class="line">    if (!user) &#123;</div><div class="line">      req.flash(&apos;error&apos;, &apos;用户不存在!&apos;); </div><div class="line">      return res.redirect(&apos;/login&apos;);//用户不存在则跳转到登录页</div><div class="line">    &#125;</div><div class="line">    //检查密码是否一致</div><div class="line">    if (user.password != password) &#123;</div><div class="line">      req.flash(&apos;error&apos;, &apos;密码错误!&apos;); </div><div class="line">      return res.redirect(&apos;/login&apos;);//密码错误则跳转到登录页</div><div class="line">    &#125;</div><div class="line">    //用户名密码都匹配后，将用户信息存入 session</div><div class="line">    req.session.user = user;</div><div class="line">    req.flash(&apos;success&apos;, &apos;登陆成功!&apos;);</div><div class="line">    res.redirect(&apos;/&apos;);//登陆成功后跳转到主页</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>将 <code>app.get(&#39;/login&#39;)</code> 修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/login&apos;, function (req, res) &#123;</div><div class="line">    res.render(&apos;login&apos;, &#123;</div><div class="line">        title: &apos;登录&apos;,</div><div class="line">        user: req.session.user,</div><div class="line">        success: req.flash(&apos;success&apos;).toString(),</div><div class="line">        error: req.flash(&apos;error&apos;).toString()&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>(这样就不会出现 ‘user is not defined’ 的错误了)</p>
<p>接下来我们实现登出响应。修改 <code>app.get(&#39;/logout&#39;)</code> 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/logout&apos;, function (req, res) &#123;</div><div class="line">  req.session.user = null;</div><div class="line">  req.flash(&apos;success&apos;, &apos;登出成功!&apos;);</div><div class="line">  res.redirect(&apos;/&apos;);//登出成功后跳转到主页</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>注意：</strong>通过把 req.session.user 赋值 null 丢掉 session 中用户的信息，实现用户的退出。</p>
<p>登录后页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.14.jpg?raw=true" alt="img"></p>
<p>登出后页面显示如下：</p>
<p><img src="https://github.com/nswbmw/N-blog/raw/master/public/images/1.15.jpg?raw=true" alt="img"></p>
<p>至此，我们实现了用户注册与登陆的功能，并且根据用户登录状态显示不同的导航。</p>
<h3 id="页面和权限控制"><a href="#页面和权限控制" class="headerlink" title="页面和权限控制"></a>页面和权限控制</h3><p>我们虽然已经完成了用户注册与登陆的功能，但并不能阻止比如已经登陆的用户访问 localhost:3000/reg 页面，读者可亲自尝试下。为此，我们需要为页面设置访问权限。即注册和登陆页面应该阻止已登陆的用户访问，登出及后面我们将要实现的发表页只对已登录的用户开放。如何实现页面权限的控制呢？我们可以把用户登录状态的检查放到路由中间件中，在每个路径前增加路由中间件，即可实现页面权限控制。我们添加 <code>checkNotLogin</code> 和 <code>checkLogin</code> 函数来实现这个功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">function checkLogin(req, res, next) &#123;</div><div class="line">  if (!req.session.user) &#123;</div><div class="line">    req.flash(&apos;error&apos;, &apos;未登录!&apos;); </div><div class="line">    res.redirect(&apos;/login&apos;);</div><div class="line">  &#125;</div><div class="line">  next();</div><div class="line">&#125;</div><div class="line"></div><div class="line">function checkNotLogin(req, res, next) &#123;</div><div class="line">  if (req.session.user) &#123;</div><div class="line">    req.flash(&apos;error&apos;, &apos;已登录!&apos;); </div><div class="line">    res.redirect(&apos;back&apos;);//返回之前的页面</div><div class="line">  &#125;</div><div class="line">  next();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>checkNotLogin</code> 和 <code>checkLogin</code> 用来检测是否登陆，并通过 <code>next()</code> 转移控制权，检测到未登录则跳转到登录页，检测到已登录则跳转到前一个页面。</p>
<p>最终 index.js 代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line">var crypto = require(&apos;crypto&apos;),</div><div class="line">    User = require(&apos;../models/user.js&apos;);</div><div class="line"></div><div class="line">module.exports = function(app) &#123;</div><div class="line">  app.get(&apos;/&apos;, function (req, res) &#123;</div><div class="line">    res.render(&apos;index&apos;, &#123;</div><div class="line">      title: &apos;主页&apos;,</div><div class="line">      user: req.session.user,</div><div class="line">      success: req.flash(&apos;success&apos;).toString(),</div><div class="line">      error: req.flash(&apos;error&apos;).toString()</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.get(&apos;/reg&apos;, checkNotLogin);</div><div class="line">  app.get(&apos;/reg&apos;, function (req, res) &#123;</div><div class="line">    res.render(&apos;reg&apos;, &#123;</div><div class="line">      title: &apos;注册&apos;,</div><div class="line">      user: req.session.user,</div><div class="line">      success: req.flash(&apos;success&apos;).toString(),</div><div class="line">      error: req.flash(&apos;error&apos;).toString()</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.post(&apos;/reg&apos;, checkNotLogin);</div><div class="line">  app.post(&apos;/reg&apos;, function (req, res) &#123;</div><div class="line">    var name = req.body.name,</div><div class="line">        password = req.body.password,</div><div class="line">        password_re = req.body[&apos;password-repeat&apos;];</div><div class="line">    if (password_re != password) &#123;</div><div class="line">      req.flash(&apos;error&apos;, &apos;两次输入的密码不一致!&apos;); </div><div class="line">      return res.redirect(&apos;/reg&apos;);</div><div class="line">    &#125;</div><div class="line">    var md5 = crypto.createHash(&apos;md5&apos;),</div><div class="line">        password = md5.update(req.body.password).digest(&apos;hex&apos;);</div><div class="line">    var newUser = new User(&#123;</div><div class="line">        name: name,</div><div class="line">        password: password,</div><div class="line">        email: req.body.email</div><div class="line">    &#125;);</div><div class="line">    User.get(newUser.name, function (err, user) &#123;</div><div class="line">      if (err) &#123;</div><div class="line">        req.flash(&apos;error&apos;, err);</div><div class="line">        return res.redirect(&apos;/&apos;);</div><div class="line">      &#125;</div><div class="line">      if (user) &#123;</div><div class="line">        req.flash(&apos;error&apos;, &apos;用户已存在!&apos;);</div><div class="line">        return res.redirect(&apos;/reg&apos;);</div><div class="line">      &#125;</div><div class="line">      newUser.save(function (err, user) &#123;</div><div class="line">        if (err) &#123;</div><div class="line">          req.flash(&apos;error&apos;, err);</div><div class="line">          return res.redirect(&apos;/reg&apos;);</div><div class="line">        &#125;</div><div class="line">        req.session.user = user;</div><div class="line">        req.flash(&apos;success&apos;, &apos;注册成功!&apos;);</div><div class="line">        res.redirect(&apos;/&apos;);</div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.get(&apos;/login&apos;, checkNotLogin);</div><div class="line">  app.get(&apos;/login&apos;, function (req, res) &#123;</div><div class="line">    res.render(&apos;login&apos;, &#123;</div><div class="line">      title: &apos;登录&apos;,</div><div class="line">      user: req.session.user,</div><div class="line">      success: req.flash(&apos;success&apos;).toString(),</div><div class="line">      error: req.flash(&apos;error&apos;).toString()</div><div class="line">    &#125;); </div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.post(&apos;/login&apos;, checkNotLogin);</div><div class="line">  app.post(&apos;/login&apos;, function (req, res) &#123;</div><div class="line">    var md5 = crypto.createHash(&apos;md5&apos;),</div><div class="line">        password = md5.update(req.body.password).digest(&apos;hex&apos;);</div><div class="line">    User.get(req.body.name, function (err, user) &#123;</div><div class="line">      if (!user) &#123;</div><div class="line">        req.flash(&apos;error&apos;, &apos;用户不存在!&apos;); </div><div class="line">        return res.redirect(&apos;/login&apos;);</div><div class="line">      &#125;</div><div class="line">      if (user.password != password) &#123;</div><div class="line">        req.flash(&apos;error&apos;, &apos;密码错误!&apos;); </div><div class="line">        return res.redirect(&apos;/login&apos;);</div><div class="line">      &#125;</div><div class="line">      req.session.user = user;</div><div class="line">      req.flash(&apos;success&apos;, &apos;登陆成功!&apos;);</div><div class="line">      res.redirect(&apos;/&apos;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.get(&apos;/post&apos;, checkLogin);</div><div class="line">  app.get(&apos;/post&apos;, function (req, res) &#123;</div><div class="line">    res.render(&apos;post&apos;, &#123;</div><div class="line">      title: &apos;发表&apos;,</div><div class="line">      user: req.session.user,</div><div class="line">      success: req.flash(&apos;success&apos;).toString(),</div><div class="line">      error: req.flash(&apos;error&apos;).toString()</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.post(&apos;/post&apos;, checkLogin);</div><div class="line">  app.post(&apos;/post&apos;, function (req, res) &#123;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  app.get(&apos;/logout&apos;, checkLogin);</div><div class="line">  app.get(&apos;/logout&apos;, function (req, res) &#123;</div><div class="line">    req.session.user = null;</div><div class="line">    req.flash(&apos;success&apos;, &apos;登出成功!&apos;);</div><div class="line">    res.redirect(&apos;/&apos;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  function checkLogin(req, res, next) &#123;</div><div class="line">    if (!req.session.user) &#123;</div><div class="line">      req.flash(&apos;error&apos;, &apos;未登录!&apos;); </div><div class="line">      res.redirect(&apos;/login&apos;);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  function checkNotLogin(req, res, next) &#123;</div><div class="line">    if (req.session.user) &#123;</div><div class="line">      req.flash(&apos;error&apos;, &apos;已登录!&apos;); </div><div class="line">      res.redirect(&apos;back&apos;);</div><div class="line">    &#125;</div><div class="line">    next();</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><strong>注意：</strong>为了维护用户状态和 flash 的通知功能，我们给每个 ejs 模版文件传入了以下三个值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">user: req.session.user,</div><div class="line">success: req.flash(&apos;success&apos;).toString(),</div><div class="line">error: req.flash(&apos;error&apos;).toString()</div></pre></td></tr></table></figure>
<h2 id="发表文章"><a href="#发表文章" class="headerlink" title="发表文章"></a>发表文章</h2><p>现在我们的博客已经具备了用户注册、登陆、页面权限控制的功能，接下来我们完成博客最核心的部分——发表文章。在这一节，我们将会实现发表文章的功能，完成整个博客的设计。</p>
<h3 id="页面设计-1"><a href="#页面设计-1" class="headerlink" title="页面设计"></a>页面设计</h3><p>我们先来完成发表页的页面设计。在 views 文件夹下新建 post.ejs ，添加如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span> <span class="attr">header</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></div><div class="line">  标题：<span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"title"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  正文：<span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">"post"</span> <span class="attr">rows</span>=<span class="string">"20"</span> <span class="attr">cols</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"发表"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">%-</span> <span class="attr">include</span> <span class="attr">footer</span> %&gt;</span></div></pre></td></tr></table></figure>
<h3 id="文章模型"><a href="#文章模型" class="headerlink" title="文章模型"></a>文章模型</h3><p>仿照用户模型，我们将文章模型命名为 Post 对象，它拥有与 User 相似的接口，分别是 <code>Post.get</code>和 <code>Post.prototype.save</code> 。<code>Post.get</code> 的功能是从数据库中获取文章，可以按指定用户获取，也可以获取全部的内容。<code>Post.prototype.save</code> 是 Post 对象原型的方法，用来将文章保存到数据库。<br>在 models 文件夹下新建 post.js ，添加如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mongodb = <span class="built_in">require</span>(<span class="string">'./db'</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Post</span>(<span class="params">name, title, post</span>) </span>&#123;</div><div class="line">  <span class="keyword">this</span>.name = name;</div><div class="line">  <span class="keyword">this</span>.title = title;</div><div class="line">  <span class="keyword">this</span>.post = post;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">module</span>.exports = Post;</div><div class="line"></div><div class="line"><span class="comment">//存储一篇文章及其相关信息</span></div><div class="line">Post.prototype.save = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  <span class="comment">//存储各种时间格式，方便以后扩展</span></div><div class="line">  <span class="keyword">var</span> time = &#123;</div><div class="line">      <span class="attr">date</span>: date,</div><div class="line">      <span class="attr">year</span> : date.getFullYear(),</div><div class="line">      <span class="attr">month</span> : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>),</div><div class="line">      <span class="attr">day</span> : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>) + <span class="string">"-"</span> + date.getDate(),</div><div class="line">      <span class="attr">minute</span> : date.getFullYear() + <span class="string">"-"</span> + (date.getMonth() + <span class="number">1</span>) + <span class="string">"-"</span> + date.getDate() + <span class="string">" "</span> + </div><div class="line">      date.getHours() + <span class="string">":"</span> + (date.getMinutes() &lt; <span class="number">10</span> ? <span class="string">'0'</span> + date.getMinutes() : date.getMinutes()) </div><div class="line">  &#125;</div><div class="line">  <span class="comment">//要存入数据库的文档</span></div><div class="line">  <span class="keyword">var</span> post = &#123;</div><div class="line">      <span class="attr">name</span>: <span class="keyword">this</span>.name,</div><div class="line">      <span class="attr">time</span>: time,</div><div class="line">      <span class="attr">title</span>: <span class="keyword">this</span>.title,</div><div class="line">      <span class="attr">post</span>: <span class="keyword">this</span>.post</div><div class="line">  &#125;;</div><div class="line">  <span class="comment">//打开数据库</span></div><div class="line">  mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      <span class="keyword">return</span> callback(err);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//读取 posts 集合</span></div><div class="line">    db.collection(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, collection</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">return</span> callback(err);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//将文档插入 posts 集合</span></div><div class="line">      collection.insert(post, &#123;</div><div class="line">        <span class="attr">safe</span>: <span class="literal">true</span></div><div class="line">      &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          <span class="keyword">return</span> callback(err);<span class="comment">//失败！返回 err</span></div><div class="line">        &#125;</div><div class="line">        callback(<span class="literal">null</span>);<span class="comment">//返回 err 为 null</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//读取文章及其相关信息</span></div><div class="line">Post.get = <span class="function"><span class="keyword">function</span>(<span class="params">name, callback</span>) </span>&#123;</div><div class="line">  <span class="comment">//打开数据库</span></div><div class="line">  mongodb.open(<span class="function"><span class="keyword">function</span> (<span class="params">err, db</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">      <span class="keyword">return</span> callback(err);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//读取 posts 集合</span></div><div class="line">    db.collection(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, collection</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (err) &#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">return</span> callback(err);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">var</span> query = &#123;&#125;;</div><div class="line">      <span class="keyword">if</span> (name) &#123;</div><div class="line">        query.name = name;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//根据 query 对象查询文章</span></div><div class="line">      collection.find(query).sort(&#123;</div><div class="line">        <span class="attr">time</span>: <span class="number">-1</span></div><div class="line">      &#125;).toArray(<span class="function"><span class="keyword">function</span> (<span class="params">err, docs</span>) </span>&#123;</div><div class="line">        mongodb.close();</div><div class="line">        <span class="keyword">if</span> (err) &#123;</div><div class="line">          <span class="keyword">return</span> callback(err);<span class="comment">//失败！返回 err</span></div><div class="line">        &#125;</div><div class="line">        callback(<span class="literal">null</span>, docs);<span class="comment">//成功！以数组形式返回查询的结果</span></div><div class="line">      &#125;);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="发表响应"><a href="#发表响应" class="headerlink" title="发表响应"></a>发表响应</h3><p>接下来我们给发表文章注册响应，打开 index.js ，在 <code>User = require(&#39;../models/user.js&#39;)</code> 后添加一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">,Post = require(&apos;../models/post.js&apos;);</div></pre></td></tr></table></figure>
<p>修改 <code>app.post(&#39;/post&#39;)</code> 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">app.post(&apos;/post&apos;, checkLogin);</div><div class="line">app.post(&apos;/post&apos;, function (req, res) &#123;</div><div class="line">  var currentUser = req.session.user,</div><div class="line">      post = new Post(currentUser.name, req.body.title, req.body.post);</div><div class="line">  post.save(function (err) &#123;</div><div class="line">    if (err) &#123;</div><div class="line">      req.flash(&apos;error&apos;, err); </div><div class="line">      return res.redirect(&apos;/&apos;);</div><div class="line">    &#125;</div><div class="line">    req.flash(&apos;success&apos;, &apos;发布成功!&apos;);</div><div class="line">    res.redirect(&apos;/&apos;);//发表成功跳转到主页</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>最后，我们修改 index.ejs ，让主页右侧显示发表过的文章及其相关信息。</p>
<p>打开 index.ejs ，修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;%- include header %&gt;</div><div class="line">&lt;% posts.forEach(function (post, index) &#123; %&gt;</div><div class="line">  &lt;p&gt;&lt;h2&gt;&lt;a href=&quot;#&quot;&gt;&lt;%= post.title %&gt;&lt;/a&gt;&lt;/h2&gt;&lt;/p&gt;</div><div class="line">  &lt;p class=&quot;info&quot;&gt;</div><div class="line">    作者：&lt;a href=&quot;#&quot;&gt;&lt;%= post.name %&gt;&lt;/a&gt; | </div><div class="line">    日期：&lt;%= post.time.minute %&gt;</div><div class="line">  &lt;/p&gt;</div><div class="line">  &lt;p&gt;&lt;%- post.post %&gt;&lt;/p&gt;</div><div class="line">&lt;% &#125;) %&gt;</div><div class="line">&lt;%- include footer %&gt;</div></pre></td></tr></table></figure>
<p>打开 index.js ，修改 <code>app.get(&#39;/&#39;)</code> 如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">app.get(&apos;/&apos;, function (req, res) &#123;</div><div class="line">  Post.get(null, function (err, posts) &#123;</div><div class="line">    if (err) &#123;</div><div class="line">      posts = [];</div><div class="line">    &#125; </div><div class="line">    res.render(&apos;index&apos;, &#123;</div><div class="line">      title: &apos;主页&apos;,</div><div class="line">      user: req.session.user,</div><div class="line">      posts: posts,</div><div class="line">      success: req.flash(&apos;success&apos;).toString(),</div><div class="line">      error: req.flash(&apos;error&apos;).toString()</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>至此，我们的博客就建成了。</p>
<p>启动我们的博客，发表一篇博文，如图所示:</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/04/express/" data-id="cizxzbgpv0009rscfk96tl87a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/">express</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nodejs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/03/01/nodejs/" class="article-date">
  <time datetime="2017-03-01T04:59:15.000Z" itemprop="datePublished">2017-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/03/01/nodejs/">Node.JS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>##Node.JS 简介</p>
<ul>
<li>共享状态的并发。注意回调函数和错误处理修改内存中的变量（状态）。</li>
<li>阻塞与非阻塞。nodejs采用事件轮询，故<strong>setTimeout()</strong>是非阻塞的，异步的。</li>
<li>Node并发采用事件轮询。</li>
<li>单线程。调用（执行）堆栈</li>
<li>错误处理。</li>
<li>堆栈追踪</li>
</ul>
<p>##Node 中的 API</p>
<ul>
<li>全局对象 <strong>global</strong></li>
<li>模块系统的三个核心对象:require,module,export</li>
<li>事件，监听。</li>
<li>buffer</li>
<li>stream</li>
<li>监视</li>
<li>事件驱动 <strong>events</strong><ul>
<li>events.EventEmitter</li>
</ul>
</li>
</ul>
<h2 id="exports-和-module-exports"><a href="#exports-和-module-exports" class="headerlink" title="exports 和 module.exports"></a>exports 和 module.exports</h2><ol>
<li>module.exports 初始值为一个空对象 {}</li>
<li>exports 是指向的 module.exports 的引用</li>
<li>require() 返回的是 module.exports 而不是 exports</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://crazycs.com/2017/03/01/nodejs/" data-id="cizxzbgpq0006rscfprdpc517" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Node-js简介/">Node.js简介</a></li></ul>

    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js简介/">Node.js简介</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/MongoDB/" style="font-size: 10px;">MongoDB</a> <a href="/tags/Node-js简介/" style="font-size: 10px;">Node.js简介</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/nodejs/" style="font-size: 20px;">nodejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/03/06/Session/">Session</a>
          </li>
        
          <li>
            <a href="/2017/03/05/Promise/">Promise</a>
          </li>
        
          <li>
            <a href="/2017/03/05/MongoDB/">MongoDB</a>
          </li>
        
          <li>
            <a href="/2017/03/04/blog/">github+hexo搭建博客笔记</a>
          </li>
        
          <li>
            <a href="/2017/03/04/express/">express</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 crazycs<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>